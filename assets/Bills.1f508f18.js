import{c4 as Ve,r,c as Se,aI as n,a5 as f,u as P,P as i,a3 as p,bb as a,d as t,bE as c,bD as j,a6 as o,M as H,ac as d,a4 as b,F as oe,aO as ue,aL as Qe,aJ as Be}from"./index.104f6ae1.js";import{Q as W}from"./QBtnGroup.fcc107dc.js";import{Q as D}from"./QInput.2343ca30.js";import{Q as $e,c as X,d as x,e as ne,f as Z}from"./QCardActions.e5ce3c72.js";import{a as O,Q as L}from"./QBadge.e5611531.js";import{Q as ee}from"./QSeparator.66c9c541.js";import{p as ie,n as re,o as w}from"./rtl.9bf9d968.js";import{Q as V,a as K}from"./QCard.4f99fc1d.js";import{a as De}from"./use-quasar.f532f3dd.js";import{a as Ne,u as le}from"./index.3178a3ef.js";import{u as Me}from"./sale-store.c83f31eb.js";import{u as Ae}from"./product-store.c13069a5.js";import{u as Ie}from"./payment-mode-store.19fa488f.js";import{e as Le}from"./receipt.a2190c3f.js";import"./use-dark.abb6de42.js";import"./module_calls.c637478d.js";import"./helpers.d60dad50.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const q=U=>(Qe("data-v-3cf7ab51"),U=U(),Be(),U),Ue={class:"q-pa-md"},ze={key:0},Te={key:1},Ee={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Fe={key:1,class:"text-center"},He={class:"text-center"},Oe=q(()=>o("br",null,null,-1)),Ke=q(()=>o("br",null,null,-1)),Ye=q(()=>o("br",null,null,-1)),Ge={key:0},Je=q(()=>o("br",null,null,-1)),Re={key:1},je={key:2},We=q(()=>o("hr",null,null,-1)),Xe=q(()=>o("b",null,"Add Product",-1)),Ze={key:0},el=q(()=>o("hr",null,null,-1)),ll={class:"text-center error_msg"},tl=q(()=>o("div",{class:"text-h6"},"Make Payment",-1)),al={class:"q-mt-sm"},sl={key:2,class:"q-pa-sm"},ol={class:"row q-col-gutter-sm"},ul={key:3,class:"q-pa-sm"},nl={class:"text-center error_msg"},il={border:"1",style:{width:"100%","border-collapse":"collapse"}},rl=q(()=>o("tr",null,[o("th",{class:"text-center q-pa-sm"},"Amount Paid"),o("th",{class:"text-center q-pa-sm"},"Balance"),o("th",{class:"text-center q-pa-sm"},"Mode"),o("th",{class:"text-center q-pa-sm"},"Cleared By"),o("th",{class:"text-center q-pa-sm"},"Cleared On")],-1)),dl={class:"text-center q-pa-sm"},cl={class:"text-center q-pa-sm"},ml={class:"text-center q-pa-sm"},_l={class:"text-center q-pa-sm"},pl={class:"text-center q-pa-sm"},fl={__name:"Bills",setup(U){const N=Ne(),de=De(),Y=r(""),M=Me(),ce=Ae(),me=Ie(),C=r(!1),m=r(!1),z=r(!1),S=r(""),A=r(!0),I=r(!1),k=r(1),Q=r(1),G=r(1),J=r(1),T=r(""),y=r(""),_=r(""),v=r(""),h=r(""),B=r([]),E=r([]),{data:te,isLoading:_e,isError:ae}=le("bills",()=>M.fetchBills(),{onSuccess:s=>{E.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,debtor_name:l.debtor_name,total_debt_paid:l.total_debt_paid,debt_records:l.debt_records,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});le("products",()=>ce.fetchProducts(),{onSuccess:s=>{B.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:pe}=le("payment_modes",()=>me.fetchPaymentModes()),R=r(B.value),fe=s=>{y.value=s,C.value=!0},ve=s=>{S.value=s,z.value=!0},be=()=>{S.value="",z.value=!1},F=Se(()=>{let s=0;return y.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),ye=s=>{y.value=s,I.value=!0},ge=()=>{h.value="",C.value=!1,_.value="",k.value=1,h.value=""},he=async()=>{if(m.value=!0,y.value.sales.some(s=>s.name===_.value.name))h.value="Product already added to the bill",g("Product already added to the bill","red","top-right");else if(k.value>_.value.quantity)h.value=`${k.value} is more than the maximum available quantity`,g(`${k.value} is more than the maximum available quantity`,"red","top");else{const s=await M.addProductToBill({bill_uuid:y.value.uuid,uuid:_.value.uuid,name:_.value.name,selling_price:_.value.price,quantity:k.value,product_uuid:_.value.uuid});s.status=="success"?(N.refetchQueries("bills"),y.value="",C.value=!1,m.value=!1,g(s.message,"green","top")):(m.value=!1,y.value="",C.value=!1,g(s.message,"red","top"))}},we=()=>{I.value=!1,v.value="",h.value=""},ke=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await M.removeProductFromBill({product_uuid:s.uuid,product_name:s.name,quantity:s.quantity});e.status=="success"?(N.refetchQueries("bills"),m.value=!1,g(e.message,"green","top")):(y.value="",m.value=!1,C.value=!1,g(e.message,"red","top"))}},qe=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await M.deleteBill({bill_uuid:s.uuid});e.status=="success"?(N.refetchQueries("bills"),m.value=!1,g(e.message,"green","top")):(m.value=!1,y.value="",C.value=!1,g(e.message,"red","top"))}},Ce=async()=>{console.log("Test ok"),m.value=!0;let s=[];y.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:y.value.uuid,products:s,payment_mode_uuid:v.value.uuid,bill_status:"sold",debtor_name:T.value.trim()};if(v.value.name==="Mpesa & Cash"){const e=Number(G.value)+Number(J.value);l.selling_price=e,l.actual_selling_price=e}else A.value?(l.selling_price=Number(F.value),l.actual_selling_price=Number(F.value)):(l.selling_price=Number(F.value),l.actual_selling_price=Number(Q.value));if(l.actual_selling_price&&l.payment_mode_uuid)if(v.value.name==="Debt"&&!T.value)alert("Debtor name is required."),h.value="Debtor name is required.",m.value=!1;else{const e=await M.updateSaleOperation(l);e.status==="success"?(N.refetchQueries("bills"),v.value="",k.value="",I.value=!1,m.value=!1,g(e.message,"green","top")):(h.value=e.message,g(e.message,"red","top-right"))}else m.value=!1,h.value="Name is required!",g("Name is required!","red","top-right")},xe=(s,l)=>{s.length>0&&(B.value.includes(s)||B.value.push(s),l(s,"toggle"))},Pe=(s,l)=>{l(()=>{if(s==="")R.value=B.value;else{const e=s.toLowerCase();R.value=B.value.filter(u=>u.name.toLowerCase().indexOf(e)>-1)}})},se=s=>{const l=[];s.sales.forEach(u=>{l.push({name:u.name,quantity:u.quantity,price:u.selling_price,total:u.quantity*u.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Le(l,["name","quantity","price","total"],e)},g=(s,l,e)=>{de.notify({message:s,color:l,position:e})};return(s,l)=>(n(),f("div",Ue,[P(_e)?(n(),f("div",ze,"Loading bills...")):P(ae)?(n(),f("div",Te,"An error has occurred: "+i(P(ae)),1)):(n(),p($e,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:E.value,"row-key":"bill_ref",filter:Y.value},{"top-right":a(()=>[t(W,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(c,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>P(N).refetchQueries("bills"))}),t(c,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var u;return E.value=(u=P(te))==null?void 0:u.filter($=>$.status==="sold")})}),t(c,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var u;return E.value=(u=P(te))==null?void 0:u.filter($=>$.status==="pending")})}),t(c,{icon:"pan_tool",size:"sm",color:"orange",label:"Clear Bills",to:"/clear_bills"})]),_:1}),t(D,{dense:"",debounce:"300",outlined:"",modelValue:Y.value,"onUpdate:modelValue":l[3]||(l[3]=e=>Y.value=e),placeholder:"Search"},{append:a(()=>[t(j,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[o("div",Ee,[t(K,{bordered:"",class:H(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[o("div",{class:H(["text-center q-pa-xs",`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[o("small",null,[o("strong",null,[t(j,{name:"description",style:{"margin-bottom":"2px"}}),d(" BILL-"+i(e.row.bill_ref),1)])])],2),t(V,null,{default:a(()=>[e.row.status==="pending"?(n(),p(O,{key:0},{default:a(()=>[o("strong",null," Created by : "+i(e.row.user),1),t(x),t(W,null,{default:a(()=>[t(c,{round:"",size:"sm",color:"blue",icon:"add",onClick:u=>fe(e.row)},null,8,["onClick"]),t(c,{size:"sm",round:"",color:"red",icon:"delete",onClick:u=>qe(e.row),loading:m.value},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1024)):(n(),f("div",Fe,[o("strong",null," Created by : "+i(e.row.user),1),t(x)])),t(ee,{class:"q-mb-sm"}),o("div",He,[o("small",null,"Created On : "+i(e.row.created_at),1),d(),Oe,o("small",null,[e.row.payment_mode==="Debt"?(n(),p(L,{key:0,color:"blue"},{default:a(()=>[d("Status : "+i(e.row.status)+" ",1),Ke,d(" Mode : "+i(e.row.payment_mode),1)]),_:2},1024)):(n(),p(L,{key:1,color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[d("Status : "+i(e.row.status)+" ",1),Ye,d(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"]))])]),t(ee,{class:"q-mb-sm"}),o("small",null,[t(ie,{dense:"",bordered:"",separator:"",class:H(`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`)},{default:a(()=>[t(re,null,{default:a(()=>[t(w,null,{default:a(()=>[d("Name")]),_:1}),t(w,null,{default:a(()=>[d("Price")]),_:1}),t(w,{style:{color:"white"}},{default:a(()=>[d("Quantity")]),_:1}),t(w,{style:{color:"white"}},{default:a(()=>[d("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(w,{key:0},{default:a(()=>[d("Action")]),_:1})):b("",!0)]),_:2},1024)]),_:2},1032,["class"])]),t(ie,{dense:"",bordered:"",separator:""},{default:a(()=>[(n(!0),f(oe,null,ue(e.row.sales,(u,$)=>(n(),p(re,{key:$},{default:a(()=>[t(w,null,{default:a(()=>[d(i(u.name),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i(u.selling_price),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i(u.quantity),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i((u.quantity*u.selling_price).toFixed(2)),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(w,{key:0},{default:a(()=>[t(j,{name:"delete",color:"red",onClick:vl=>ke(u),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):b("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),t(ee),e.row.selling_price>0?(n(),p(V,{key:0,class:"text-center"},{default:a(()=>{var u;return[e.row.payment_mode==="Debt"?(n(),f("p",Ge,[d(" Debtor: "+i(e.row.debtor_name)+" ",1),Je,o("b",null,"Amount due Ksh "+i(e.row.selling_price),1)])):(n(),f("b",Re,"Price Ksh "+i(e.row.selling_price),1)),((u=e.row.debt_records)==null?void 0:u.length)>0?(n(),f("p",je,[t(c,{flat:"",size:"sm",label:"Click to View Payment History",color:"orange",onClick:$=>ve(e.row)},null,8,["onClick"])])):b("",!0)]}),_:2},1024)):b("",!0),We,t(V,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(n(),p(c,{key:0,class:"full-width",dense:"",flat:"",onClick:u=>se(e.row),label:"Print Bill",icon:"print",color:`${e.row.payment_mode==="Debt"?"blue":"primary"}`},null,8,["onClick","color"])):(n(),p(W,{key:1,class:"full-width"},{default:a(()=>[t(c,{class:"full-width",dense:"",flat:"",onClick:u=>se(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(c,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:u=>ye(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter"])),t(X,{modelValue:C.value,"onUpdate:modelValue":l[6]||(l[6]=e=>C.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(V,null,{default:a(()=>[t(O,null,{default:a(()=>[Xe,t(x),_.value?(n(),f("small",Ze,[t(L,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Price: "+i(_.value.price),1)]),_:1}),t(L,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Category: "+i(_.value.category),1)]),_:1}),t(L,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Department: "+i(_.value.department),1)]),_:1})])):b("",!0)]),_:1}),el,t(ne,{dense:"","use-input":"",outlined:"",modelValue:_.value,"onUpdate:modelValue":l[4]||(l[4]=e=>_.value=e),"input-debounce":"0",onNewValue:xe,options:R.value,onFilter:Pe,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t(V,{class:"q-pt-none"},{default:a(()=>[_.value?(n(),p(D,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:k.value,"onUpdate:modelValue":l[5]||(l[5]=e=>k.value=e),type:"number",hint:`Note : You can sale a maximum of ${_.value.quantity}`},null,8,["modelValue","hint"])):b("",!0)]),_:1}),o("div",ll,[o("small",null,i(h.value),1)]),t(Z,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:ge}),t(x),k.value&&_.value?(n(),p(c,{key:0,flat:"",label:"Add Product",color:"primary",onClick:he,loading:m.value},null,8,["loading"])):b("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(X,{modelValue:I.value,"onUpdate:modelValue":l[13]||(l[13]=e=>I.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(O,null,{default:a(()=>[tl,t(x),o("small",al,[t(c,{disabled:v.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:H(`${A.value?"":"actual_selling_price"}`),onClick:l[7]||(l[7]=e=>A.value=!A.value),label:`Expected Selling Price : ${F.value}`},null,8,["disabled","class","label"])])]),_:1}),t(V,{class:"q-pt-none"},{default:a(()=>[!A.value&&v.value.name!=="Mpesa & Cash"?(n(),p(D,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:Q.value,"onUpdate:modelValue":l[8]||(l[8]=e=>Q.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):b("",!0),Q.value&&Q.value>0?(n(),p(ne,{key:1,dense:"",outlined:"",modelValue:v.value,"onUpdate:modelValue":l[9]||(l[9]=e=>v.value=e),options:P(pe).filter(e=>e.name!=="Debt"),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):b("",!0),v.value.name==="Mpesa & Cash"?(n(),f("div",sl,[o("div",ol,[t(D,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:G.value,"onUpdate:modelValue":l[10]||(l[10]=e=>G.value=e)},null,8,["modelValue"]),t(D,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:J.value,"onUpdate:modelValue":l[11]||(l[11]=e=>J.value=e)},null,8,["modelValue"])])])):b("",!0),v.value.name==="Debt"?(n(),f("div",ul,[t(D,{outlined:"",modelValue:T.value,"onUpdate:modelValue":l[12]||(l[12]=e=>T.value=e),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):b("",!0)]),_:1}),o("div",nl,[o("small",null,i(h.value),1)]),t(Z,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:we}),t(x),Q.value&&v.value?(n(),p(c,{key:0,flat:"",label:"Sale",color:"primary",onClick:Ce,loading:m.value},null,8,["loading"])):b("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(X,{modelValue:z.value,"onUpdate:modelValue":l[15]||(l[15]=e=>z.value=e),persistent:""},{default:a(()=>[t(K,null,{default:a(()=>[t(O,{class:"bg-orange text-white q-mb-sm"},{default:a(()=>[o("b",null,"Payment History for BILL-"+i(S.value.bill_ref)+". ",1),t(x),o("b",null,"Name: "+i(S.value.debtor_name)+". ",1)]),_:1}),t(V,{class:"q-pt-none"},{default:a(()=>[o("small",null,[o("table",il,[rl,(n(!0),f(oe,null,ue(S.value.debt_records,e=>(n(),f("tr",{key:e.uuid},[o("td",dl,i(e.amount_paid),1),o("td",cl,i(e.balance),1),o("td",ml,i(e.payment_mode),1),o("td",_l,i(e.user),1),o("td",pl,i(e.created_at),1)]))),128))])])]),_:1}),t(Z,null,{default:a(()=>[t(c,{dense:"",flat:"",label:`Total Paid: ${S.value.total_debt_paid}`,color:"primary",disabled:""},null,8,["label"]),t(x),t(c,{dense:"",outline:"",label:"Close History",color:"primary",onClick:l[14]||(l[14]=e=>be())})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var Il=Ve(fl,[["__scopeId","data-v-3cf7ab51"]]);export{Il as default};
