import{c4 as ke,r as d,c as qe,aI as u,a5 as h,u as C,P as i,a3 as _,bb as t,b as Ce,d as a,bE as p,bD as G,a6 as n,M as T,ac as r,a4 as y,F as Se,aO as Ve,aL as Qe,aJ as Pe}from"./index.0fdde7d8.js";import{Q as J}from"./QBtnGroup.5b507273.js";import{Q as P}from"./QInput.38269e70.js";import{Q as xe,c as ae,p as Be,d as x,e as te,f as se}from"./paginations.d5ef5921.js";import{a as j,Q as U}from"./QBadge.0c8833c5.js";import{Q as H}from"./QSeparator.0d2732c0.js";import{p as oe,n as ue,o as w}from"./rtl.ac90c64b.js";import{Q as B,a as W}from"./QCard.2399c3c3.js";import{a as De}from"./use-quasar.cc67a347.js";import{a as $e,u as X}from"./index.82ab6ec2.js";import{u as Ne}from"./sale-store.6c59e51b.js";import{u as Me}from"./product-store.5917bf24.js";import{u as Ae}from"./payment-mode-store.daf14280.js";import{e as Ue}from"./receipt.a2190c3f.js";import"./use-dark.e1785afc.js";import"./module_calls.b5021e26.js";import"./helpers.3d5d05cf.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const S=I=>(Qe("data-v-2c6cd4ec"),I=I(),Pe(),I),Ie={class:"q-pa-md"},Le={key:0},ze={key:1},Ee={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Te={key:1,class:"text-center"},Fe={class:"text-center"},Oe=S(()=>n("br",null,null,-1)),Ke=S(()=>n("br",null,null,-1)),Re=S(()=>n("br",null,null,-1)),Ye={key:0},Ge=S(()=>n("br",null,null,-1)),Je={key:1},je=S(()=>n("hr",null,null,-1)),He=S(()=>n("b",null,"Add Product",-1)),We={key:0},Xe=S(()=>n("hr",null,null,-1)),Ze={class:"text-center error_msg"},el=S(()=>n("div",{class:"text-h6"},"Make Payment",-1)),ll={class:"q-mt-sm"},al={key:2,class:"q-pa-sm"},tl={class:"row q-col-gutter-sm"},sl={key:3,class:"q-pa-sm"},ol={class:"text-center error_msg"},ul={__name:"Bills",setup(I){const D=$e(),ne=De(),F=Be(10),O=d(""),$=Ne(),ie=Me(),re=Ae(),q=d(!1),c=d(!1),N=d(!0),M=d(!1),k=d(1),V=d(1),K=d(1),R=d(1),L=d(""),v=d(""),m=d(""),f=d(""),g=d(""),Q=d([]),z=d([]),{data:Z,isLoading:de,isError:ee}=X("bills",()=>$.fetchBills(),{onSuccess:s=>{z.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,debtor_name:l.debtor_name,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});X("products",()=>ie.fetchProducts(),{onSuccess:s=>{Q.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:ce}=X("payment_modes",()=>re.fetchPaymentModes()),Y=d(Q.value),me=s=>{v.value=s,q.value=!0},E=qe(()=>{let s=0;return v.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),_e=s=>{v.value=s,M.value=!0},pe=()=>{g.value="",q.value=!1,m.value="",k.value=1,g.value=""},fe=async()=>{if(c.value=!0,v.value.sales.some(s=>s.name===m.value.name))g.value="Product already added to the bill",b("Product already added to the bill","red","top-right");else if(k.value>m.value.quantity)g.value=`${k.value} is more than the maximum available quantity`,b(`${k.value} is more than the maximum available quantity`,"red","top");else{const s=await $.addProductToBill({bill_uuid:v.value.uuid,uuid:m.value.uuid,name:m.value.name,selling_price:m.value.price,quantity:k.value});s.status=="success"?(D.refetchQueries("bills"),v.value="",q.value=!1,c.value=!1,b(s.message,"green","top")):(c.value=!1,v.value="",q.value=!1,b(s.message,"red","top"))}},ve=()=>{M.value=!1,f.value="",g.value=""},be=async s=>{if(c.value=!0,confirm("Are you sure?")){const e=await $.removeProductFromBill({product_uuid:s.uuid});e.status=="success"?(D.refetchQueries("bills"),c.value=!1,b(e.message,"green","top")):(v.value="",c.value=!1,q.value=!1,b(e.message,"red","top"))}},ye=async s=>{if(c.value=!0,confirm("Are you sure?")){const e=await $.deleteBill({bill_uuid:s.uuid});e.status=="success"?(D.refetchQueries("bills"),c.value=!1,b(e.message,"green","top")):(c.value=!1,v.value="",q.value=!1,b(e.message,"red","top"))}},ge=async()=>{c.value=!0;let s=[];v.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:v.value.uuid,products:s,payment_mode_uuid:f.value.uuid,bill_status:"sold",debtor_name:L.value.trim()};if(f.value.name==="Mpesa & Cash"){const e=Number(K.value)+Number(R.value);l.selling_price=e,l.actual_selling_price=e}else N.value?(l.selling_price=Number(E.value),l.actual_selling_price=Number(E.value)):(l.selling_price=Number(E.value),l.actual_selling_price=Number(V.value));if(l.actual_selling_price&&l.payment_mode_uuid)if(f.value.name==="Debt"&&!L.value)alert("Debtor name is required."),g.value="Debtor name is required.",c.value=!1;else{const e=await $.updateSaleOperation(l);e.status==="success"?(D.refetchQueries("bills"),f.value="",k.value="",M.value=!1,c.value=!1,b(e.message,"green","top")):(g.value=e.message,b(e.message,"red","top-right"))}else c.value=!1,g.value="Name is required!",b("Name is required!","red","top-right")},he=(s,l)=>{s.length>0&&(Q.value.includes(s)||Q.value.push(s),l(s,"toggle"))},we=(s,l)=>{l(()=>{if(s==="")Y.value=Q.value;else{const e=s.toLowerCase();Y.value=Q.value.filter(o=>o.name.toLowerCase().indexOf(e)>-1)}})},le=s=>{const l=[];s.sales.forEach(o=>{l.push({name:o.name,quantity:o.quantity,price:o.selling_price,total:o.quantity*o.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Ue(l,["name","quantity","price","total"],e)},b=(s,l,e)=>{ne.notify({message:s,color:l,position:e})};return(s,l)=>(u(),h("div",Ie,[C(de)?(u(),h("div",Le,"Loading bills...")):C(ee)?(u(),h("div",ze,"An error has occurred: "+i(C(ee)),1)):(u(),_(xe,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:z.value,"row-key":"bill_ref",filter:O.value,pagination:C(F),"onUpdate:pagination":l[4]||(l[4]=e=>Ce(F)?F.value=e:null)},{"top-right":t(()=>[a(J,{class:"q-mr-sm q-mb-sm"},{default:t(()=>[a(p,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>C(D).refetchQueries("bills"))}),a(p,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var o;return z.value=(o=C(Z))==null?void 0:o.filter(A=>A.status==="sold")})}),a(p,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var o;return z.value=(o=C(Z))==null?void 0:o.filter(A=>A.status==="pending")})}),a(p,{icon:"pan_tool",size:"sm",color:"orange",label:"Clear Bills",to:"/clear_bills"})]),_:1}),a(P,{dense:"",debounce:"300",outlined:"",modelValue:O.value,"onUpdate:modelValue":l[3]||(l[3]=e=>O.value=e),placeholder:"Search"},{append:t(()=>[a(G,{name:"search"})]),_:1},8,["modelValue"])]),item:t(e=>[n("div",Ee,[a(W,{bordered:"",class:T(`${e.row.status=="pending"?"sale_pending":""}`)},{default:t(()=>[n("div",{class:T(["text-center q-pa-xs",`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[n("small",null,[n("strong",null,[a(G,{name:"description",style:{"margin-bottom":"2px"}}),r(" BILL-"+i(e.row.bill_ref),1)])])],2),a(B,null,{default:t(()=>[e.row.status==="pending"?(u(),_(j,{key:0},{default:t(()=>[n("strong",null," Created by : "+i(e.row.user),1),a(x),a(J,null,{default:t(()=>[a(p,{round:"",size:"sm",color:"blue",icon:"add",onClick:o=>me(e.row)},null,8,["onClick"]),a(p,{size:"sm",round:"",color:"red",icon:"delete",onClick:o=>ye(e.row),loading:c.value},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1024)):(u(),h("div",Te,[n("strong",null," Created by : "+i(e.row.user),1),a(x)])),a(H,{class:"q-mb-sm"}),n("div",Fe,[n("small",null,"Created On : "+i(e.row.created_at),1),r(),Oe,n("small",null,[e.row.payment_mode==="Debt"?(u(),_(U,{key:0,color:"blue"},{default:t(()=>[r("Status : "+i(e.row.status)+" ",1),Ke,r(" Mode : "+i(e.row.payment_mode),1)]),_:2},1024)):(u(),_(U,{key:1,color:`${e.row.status=="pending"?"red":""}`},{default:t(()=>[r("Status : "+i(e.row.status)+" ",1),Re,r(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"]))])]),a(H,{class:"q-mb-sm"}),n("small",null,[a(oe,{dense:"",bordered:"",separator:"",class:T(`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`)},{default:t(()=>[a(ue,null,{default:t(()=>[a(w,null,{default:t(()=>[r("Name")]),_:1}),a(w,null,{default:t(()=>[r("Price")]),_:1}),a(w,{style:{color:"white"}},{default:t(()=>[r("Quantity")]),_:1}),a(w,{style:{color:"white"}},{default:t(()=>[r("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(u(),_(w,{key:0},{default:t(()=>[r("Action")]),_:1})):y("",!0)]),_:2},1024)]),_:2},1032,["class"])]),a(oe,{dense:"",bordered:"",separator:""},{default:t(()=>[(u(!0),h(Se,null,Ve(e.row.sales,(o,A)=>(u(),_(ue,{key:A},{default:t(()=>[a(w,null,{default:t(()=>[r(i(o.name),1)]),_:2},1024),a(w,null,{default:t(()=>[r(i(o.selling_price),1)]),_:2},1024),a(w,null,{default:t(()=>[r(i(o.quantity),1)]),_:2},1024),a(w,null,{default:t(()=>[r(i(o.quantity*o.selling_price),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(u(),_(w,{key:0},{default:t(()=>[a(G,{name:"delete",color:"red",onClick:nl=>be(o),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):y("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),a(H),e.row.selling_price>0?(u(),_(B,{key:0,class:"text-center"},{default:t(()=>[e.row.payment_mode==="Debt"?(u(),h("p",Ye,[r(" Debtor: "+i(e.row.debtor_name)+" ",1),Ge,n("b",null,"Amount due Ksh "+i(e.row.selling_price),1)])):(u(),h("b",Je,"Price Ksh "+i(e.row.selling_price),1))]),_:2},1024)):y("",!0),je,a(B,{style:{padding:"0"}},{default:t(()=>[e.row.status==="sold"?(u(),_(p,{key:0,class:"full-width",dense:"",flat:"",onClick:o=>le(e.row),label:"Print Bill",icon:"print",color:`${e.row.payment_mode==="Debt"?"blue":"primary"}`},null,8,["onClick","color"])):(u(),_(J,{key:1,class:"full-width"},{default:t(()=>[a(p,{class:"full-width",dense:"",flat:"",onClick:o=>le(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),a(p,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:o=>_e(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),a(ae,{modelValue:q.value,"onUpdate:modelValue":l[7]||(l[7]=e=>q.value=e),persistent:""},{default:t(()=>[a(W,{style:{width:"500px"}},{default:t(()=>[a(B,null,{default:t(()=>[a(j,null,{default:t(()=>[He,a(x),m.value?(u(),h("small",We,[a(U,{class:"q-mr-sm",color:"blue"},{default:t(()=>[r("Price: "+i(m.value.price),1)]),_:1}),a(U,{class:"q-mr-sm",color:"blue"},{default:t(()=>[r("Category: "+i(m.value.category),1)]),_:1}),a(U,{class:"q-mr-sm",color:"blue"},{default:t(()=>[r("Department: "+i(m.value.department),1)]),_:1})])):y("",!0)]),_:1}),Xe,a(te,{dense:"","use-input":"",outlined:"",modelValue:m.value,"onUpdate:modelValue":l[5]||(l[5]=e=>m.value=e),"input-debounce":"0",onNewValue:he,options:Y.value,onFilter:we,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),a(B,{class:"q-pt-none"},{default:t(()=>[m.value?(u(),_(P,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:k.value,"onUpdate:modelValue":l[6]||(l[6]=e=>k.value=e),type:"number",hint:`Note : You can sale a maximum of ${m.value.quantity}`},null,8,["modelValue","hint"])):y("",!0)]),_:1}),n("div",Ze,[n("small",null,i(g.value),1)]),a(se,{align:"right"},{default:t(()=>[a(p,{flat:"",label:"Cancel",color:"red",onClick:pe}),a(x),k.value&&m.value?(u(),_(p,{key:0,flat:"",label:"Add Product",color:"primary",onClick:fe,loading:c.value},null,8,["loading"])):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ae,{modelValue:M.value,"onUpdate:modelValue":l[14]||(l[14]=e=>M.value=e),persistent:""},{default:t(()=>[a(W,{style:{width:"500px"}},{default:t(()=>[a(j,null,{default:t(()=>[el,a(x),n("small",ll,[a(p,{disabled:f.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:T(`${N.value?"":"actual_selling_price"}`),onClick:l[8]||(l[8]=e=>N.value=!N.value),label:`Expected Selling Price : ${E.value}`},null,8,["disabled","class","label"])])]),_:1}),a(B,{class:"q-pt-none"},{default:t(()=>[!N.value&&f.value.name!=="Mpesa & Cash"?(u(),_(P,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:V.value,"onUpdate:modelValue":l[9]||(l[9]=e=>V.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):y("",!0),V.value&&V.value>0?(u(),_(te,{key:1,dense:"",outlined:"",modelValue:f.value,"onUpdate:modelValue":l[10]||(l[10]=e=>f.value=e),options:C(ce),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):y("",!0),f.value.name==="Mpesa & Cash"?(u(),h("div",al,[n("div",tl,[a(P,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:K.value,"onUpdate:modelValue":l[11]||(l[11]=e=>K.value=e)},null,8,["modelValue"]),a(P,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:R.value,"onUpdate:modelValue":l[12]||(l[12]=e=>R.value=e)},null,8,["modelValue"])])])):y("",!0),f.value.name==="Debt"?(u(),h("div",sl,[a(P,{outlined:"",modelValue:L.value,"onUpdate:modelValue":l[13]||(l[13]=e=>L.value=e),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):y("",!0)]),_:1}),n("div",ol,[n("small",null,i(g.value),1)]),a(se,{align:"right"},{default:t(()=>[a(p,{flat:"",label:"Cancel",color:"red",onClick:ve}),a(x),V.value&&f.value?(u(),_(p,{key:0,flat:"",label:"Sale",color:"primary",onClick:ge,loading:c.value},null,8,["loading"])):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var Ql=ke(ul,[["__scopeId","data-v-2c6cd4ec"]]);export{Ql as default};
