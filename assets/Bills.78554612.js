import{c4 as he,r as c,c as we,aI as n,a5 as Q,u as q,P as i,a3 as p,bb as a,b as ke,d as t,bE as _,bD as R,a6 as u,ac as r,a4 as y,F as Ce,aO as qe,M as ee,aL as Se,aJ as Qe}from"./index.bc27483f.js";import{Q as Y}from"./QBtnGroup.4c23ce1f.js";import{Q as D}from"./QInput.e3697c5f.js";import{Q as xe,a as le,p as Pe,d as B,b as te,c as ae}from"./paginations.fcc2a0de.js";import{Q as j}from"./QToolbar.5d923135.js";import{Q as G}from"./QSeparator.df4475a1.js";import{Q as E}from"./QBadge.c1e0609e.js";import{p as se,n as oe,o as b}from"./rtl.f0ddda94.js";import{Q as $,a as J}from"./QCard.7d1d294b.js";import{a as Ve}from"./use-quasar.e5ac4fd4.js";import{u as Be}from"./sale-store.54bd3272.js";import{u as $e}from"./product-store.32e5bc06.js";import{u as Ne}from"./payment-mode-store.21a5b03d.js";import{a as Me,u as K}from"./index.4c42915d.js";import{p as Ae}from"./print.15699711.js";import"./use-dark.c0bb3fd4.js";import"./module_calls.e16012c0.js";import"./helpers.01ee3f07.js";import"./_commonjsHelpers.6150b38b.js";const Ie=(g,m)=>{const M=g.reduce((A,S)=>A+S.total,0);return`<div style="text-align: center; padding: 10px; paddinng: 5px; margin-bottom: 20px; width: 100%">
    <h4>${m.title}</h4>
    <ul>
      <li>Total Cost : ${M}</li>
      <li>Payment Mode : ${m.payment_mode}</li>
      <li>Status : ${m.status}</li>
      <li>Created By : ${m.user}</li>
      <li>Created On : ${m.created_at}</li>
      </li>
    </ul>
  </div>`},Ue=(g,m,M)=>{const x=Ie(g,M);Ae({header:x,repeatTableHeader:!0,printable:g,properties:m,type:"json",gridHeaderStyle:"font-weight: bold; border: 2px solid;",gridStyle:"border-collapse: collapse; border: 1px solid;"})};const N=g=>(Se("data-v-470a3ace"),g=g(),Qe(),g),Le={class:"q-pa-md"},De={key:0},Te={key:1},ze={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Ee={class:"text-center q-pa-xs",style:{"background-color":"#017951",color:"white"}},Fe={key:1,class:"text-center"},Oe={class:"text-center"},He=N(()=>u("br",null,null,-1)),Re=N(()=>u("br",null,null,-1)),Ye=N(()=>u("hr",null,null,-1)),je=N(()=>u("b",null,"Add Product",-1)),Ge={key:0},Je=N(()=>u("hr",null,null,-1)),Ke={class:"text-center error_msg"},We=N(()=>u("div",{class:"text-h6"},"Make Payment",-1)),Xe={class:"q-mt-sm"},Ze={key:2,class:"q-pa-sm"},el={class:"row q-col-gutter-sm"},ll={class:"text-center error_msg"},tl={__name:"Bills",setup(g){const m=Me(),M=Ve(),x=Pe(10),A=c(""),S=Be(),ue=$e(),ne=Ne(),k=c(!1),I=c(!0),U=c(!1),h=c(1),P=c(1),F=c(1),O=c(1),f=c(""),d=c(""),w=c(""),C=c(""),V=c([]),T=c([]),{data:W,isLoading:ie,isError:X}=K("bills",()=>S.fetchBills(),{onSuccess:s=>{T.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});K("products",()=>ue.fetchProducts(),{onSuccess:s=>{V.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:re}=K("payment_modes",()=>ne.fetchPaymentModes()),H=c(V.value),de=s=>{f.value=s,k.value=!0},z=we(()=>{let s=0;return f.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),ce=s=>{f.value=s,U.value=!0},me=()=>{C.value="",k.value=!1,d.value="",h.value=1,C.value=""},pe=async()=>{if(f.value.sales.some(s=>s.name===d.value.name))C.value="Product already added to the bill",v("Product already added to the bill","red","top-right");else if(h.value>d.value.quantity)C.value=`${h.value} is more than the maximum available quantity`,v(`${h.value} is more than the maximum available quantity`,"red","top");else{const s=await S.addProductToBill({bill_uuid:f.value.uuid,uuid:d.value.uuid,name:d.value.name,selling_price:d.value.price,quantity:h.value});s.status=="success"?(m.refetchQueries("bills"),f.value="",k.value=!1,v(s.message,"green","top")):(f.value="",k.value=!1,v(s.message,"red","top"))}},_e=()=>{U.value=!1},fe=async s=>{if(confirm("Are you sure?")){const e=await S.removeProductFromBill({product_uuid:s.uuid});e.status=="success"?(m.refetchQueries("bills"),v(e.message,"green","top")):(f.value="",k.value=!1,v(e.message,"red","top"))}},ve=async s=>{if(confirm("Are you sure?")){const e=await S.deleteBill({bill_uuid:s.uuid});e.status=="success"?(m.refetchQueries("bills"),v(e.message,"green","top")):(f.value="",k.value=!1,v(e.message,"red","top"))}},ye=async()=>{let s=[];f.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:f.value.uuid,products:s,payment_mode_uuid:w.value.uuid,bill_status:"sold"};if(w.value.name==="Mpesa & Cash"){const e=Number(F.value)+Number(O.value);l.selling_price=e,l.actual_selling_price=e}else I.value?(l.selling_price=Number(z.value),l.actual_selling_price=Number(z.value)):(l.selling_price=Number(z.value),l.actual_selling_price=Number(P.value));if(l.actual_selling_price&&l.payment_mode_uuid){const e=await S.updateSaleOperation(l);e.status==="success"?(m.refetchQueries("bills"),w.value="",h.value="",U.value=!1,v(e.message,"green","top")):(C.value=e.message,v(e.message,"red","top-right"))}else C.value="Name is required!",v("Name is required!","red","top-right")},be=(s,l)=>{s.length>0&&(V.value.includes(s)||V.value.push(s),l(s,"toggle"))},ge=(s,l)=>{l(()=>{if(s==="")H.value=V.value;else{const e=s.toLowerCase();H.value=V.value.filter(o=>o.name.toLowerCase().indexOf(e)>-1)}})},Z=s=>{const l=[];s.sales.forEach(o=>{l.push({name:o.name,quantity:o.quantity,price:o.selling_price,total:o.quantity*o.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Ue(l,["name","quantity","price","total"],e)},v=(s,l,e)=>{M.notify({message:s,color:l,position:e})};return(s,l)=>(n(),Q("div",Le,[q(ie)?(n(),Q("div",De,"Loading bills...")):q(X)?(n(),Q("div",Te,"An error has occurred: "+i(q(X)),1)):(n(),p(xe,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:T.value,"row-key":"bill_ref",filter:A.value,pagination:q(x),"onUpdate:pagination":l[4]||(l[4]=e=>ke(x)?x.value=e:null)},{"top-right":a(()=>[t(Y,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(_,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>q(m).refetchQueries("bills"))}),t(_,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var o;return T.value=(o=q(W))==null?void 0:o.filter(L=>L.status==="sold")})}),t(_,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var o;return T.value=(o=q(W))==null?void 0:o.filter(L=>L.status==="pending")})})]),_:1}),t(D,{dense:"",debounce:"300",outlined:"",modelValue:A.value,"onUpdate:modelValue":l[3]||(l[3]=e=>A.value=e),placeholder:"Search"},{append:a(()=>[t(R,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[u("div",ze,[t(J,{bordered:"",class:ee(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[u("div",Ee,[u("small",null,[u("strong",null,[t(R,{name:"description",style:{"margin-bottom":"2px"}}),r(" BILL-"+i(e.row.bill_ref),1)])])]),t($,null,{default:a(()=>[e.row.status==="pending"?(n(),p(j,{key:0},{default:a(()=>[u("strong",null," Created by : "+i(e.row.user),1),t(B),t(Y,null,{default:a(()=>[t(_,{round:"",size:"sm",color:"blue",icon:"add",onClick:o=>de(e.row)},null,8,["onClick"]),t(_,{size:"sm",round:"",color:"red",icon:"delete",onClick:o=>ve(e.row)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)):(n(),Q("div",Fe,[u("strong",null," Created by : "+i(e.row.user),1),t(B)])),t(G,{class:"q-mb-sm"}),u("div",Oe,[u("small",null,"Created On : "+i(e.row.created_at),1),r(),He,u("small",null,[t(E,{color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[r("Status : "+i(e.row.status)+" ",1),Re,r(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"])])]),t(G,{class:"q-mb-sm"}),u("small",null,[t(se,{dense:"",bordered:"",separator:"",class:"bill"},{default:a(()=>[t(oe,null,{default:a(()=>[t(b,null,{default:a(()=>[r("Name")]),_:1}),t(b,null,{default:a(()=>[r("Price")]),_:1}),t(b,{style:{color:"white"}},{default:a(()=>[r("Quantity")]),_:1}),t(b,{style:{color:"white"}},{default:a(()=>[r("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(b,{key:0},{default:a(()=>[r("Action")]),_:1})):y("",!0)]),_:2},1024)]),_:2},1024)]),t(se,{dense:"",bordered:"",separator:""},{default:a(()=>[(n(!0),Q(Ce,null,qe(e.row.sales,(o,L)=>(n(),p(oe,{key:L},{default:a(()=>[t(b,null,{default:a(()=>[r(i(o.name),1)]),_:2},1024),t(b,null,{default:a(()=>[r(i(o.selling_price),1)]),_:2},1024),t(b,null,{default:a(()=>[r(i(o.quantity),1)]),_:2},1024),t(b,null,{default:a(()=>[r(i(o.quantity*o.selling_price),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(b,{key:0},{default:a(()=>[t(R,{name:"delete",color:"red",onClick:al=>fe(o),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):y("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),t(G),e.row.selling_price>0?(n(),p($,{key:0,class:"flex flex-center"},{default:a(()=>[u("b",null,"Price Ksh "+i(e.row.selling_price),1)]),_:2},1024)):y("",!0),Ye,t($,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(n(),p(_,{key:0,class:"full-width",dense:"",flat:"",onClick:o=>Z(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"])):(n(),p(Y,{key:1,class:"full-width"},{default:a(()=>[t(_,{class:"full-width",dense:"",flat:"",onClick:o=>Z(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(_,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:o=>ce(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),t(le,{modelValue:k.value,"onUpdate:modelValue":l[7]||(l[7]=e=>k.value=e),persistent:""},{default:a(()=>[t(J,{style:{width:"500px"}},{default:a(()=>[t($,null,{default:a(()=>[t(j,null,{default:a(()=>[je,t(B),d.value?(n(),Q("small",Ge,[t(E,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Price: "+i(d.value.price),1)]),_:1}),t(E,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Category: "+i(d.value.category),1)]),_:1}),t(E,{class:"q-mr-sm",color:"blue"},{default:a(()=>[r("Department: "+i(d.value.department),1)]),_:1})])):y("",!0)]),_:1}),Je,t(te,{dense:"","use-input":"",outlined:"",modelValue:d.value,"onUpdate:modelValue":l[5]||(l[5]=e=>d.value=e),"input-debounce":"0",onNewValue:be,options:H.value,onFilter:ge,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t($,{class:"q-pt-none"},{default:a(()=>[d.value?(n(),p(D,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:h.value,"onUpdate:modelValue":l[6]||(l[6]=e=>h.value=e),type:"number",hint:`Note : You can sale a maximum of ${d.value.quantity}`},null,8,["modelValue","hint"])):y("",!0)]),_:1}),u("div",Ke,[u("small",null,i(C.value),1)]),t(ae,{align:"right"},{default:a(()=>[t(_,{flat:"",label:"Cancel",color:"red",onClick:me}),t(B),h.value&&d.value?(n(),p(_,{key:0,flat:"",label:"Add Product",color:"primary",onClick:pe})):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(le,{modelValue:U.value,"onUpdate:modelValue":l[13]||(l[13]=e=>U.value=e),persistent:""},{default:a(()=>[t(J,{style:{width:"500px"}},{default:a(()=>[t(j,null,{default:a(()=>[We,t(B),u("small",Xe,[t(_,{disabled:w.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:ee(`${I.value?"":"actual_selling_price"}`),onClick:l[8]||(l[8]=e=>I.value=!I.value),label:`Expected Selling Price : ${z.value}`},null,8,["disabled","class","label"])])]),_:1}),t($,{class:"q-pt-none"},{default:a(()=>[!I.value&&w.value.name!=="Mpesa & Cash"?(n(),p(D,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:P.value,"onUpdate:modelValue":l[9]||(l[9]=e=>P.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):y("",!0),P.value&&P.value>0?(n(),p(te,{key:1,dense:"",outlined:"",modelValue:w.value,"onUpdate:modelValue":l[10]||(l[10]=e=>w.value=e),options:q(re),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):y("",!0),w.value.name==="Mpesa & Cash"?(n(),Q("div",Ze,[u("div",el,[t(D,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:F.value,"onUpdate:modelValue":l[11]||(l[11]=e=>F.value=e)},null,8,["modelValue"]),t(D,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:O.value,"onUpdate:modelValue":l[12]||(l[12]=e=>O.value=e)},null,8,["modelValue"])])])):y("",!0)]),_:1}),u("div",ll,[u("small",null,i(C.value),1)]),t(ae,{align:"right"},{default:a(()=>[t(_,{flat:"",label:"Cancel",color:"red",onClick:_e}),t(B),P.value&&w.value?(n(),p(_,{key:0,flat:"",label:"Sale",color:"primary",onClick:ye})):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var Cl=he(tl,[["__scopeId","data-v-470a3ace"]]);export{Cl as default};
