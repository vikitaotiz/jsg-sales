import{c4 as we,r,c as ke,aI as n,a5 as x,u as S,P as i,a3 as _,bb as a,b as Ce,d as t,bE as f,bD as Y,a6 as u,ac as d,a4 as y,F as Se,aO as qe,M as le,aL as Qe,aJ as xe}from"./index.43b29598.js";import{Q as j}from"./QBtnGroup.8ab77508.js";import{Q as T}from"./QInput.50502b6a.js";import{Q as Pe,c as te,p as Ve,d as $,e as ae,f as se}from"./paginations.d31396ff.js";import{a as G,Q as F}from"./QBadge.c37ec33e.js";import{Q as J}from"./QSeparator.00910b71.js";import{p as oe,n as ue,o as b}from"./rtl.e3274486.js";import{Q as N,a as K}from"./QCard.287aa4cb.js";import{a as Be}from"./use-quasar.811db318.js";import{u as $e}from"./sale-store.f9d6ab4b.js";import{u as Ne}from"./product-store.37496ad2.js";import{u as Me}from"./payment-mode-store.c7d091aa.js";import{a as Ae,u as W}from"./index.fe5141b8.js";import{p as Ie}from"./print.15699711.js";import"./use-dark.ad1ce312.js";import"./module_calls.e16012c0.js";import"./helpers.01ee3f07.js";import"./_commonjsHelpers.6150b38b.js";const Ue=(h,p)=>{const A=h.reduce((I,q)=>I+q.total,0);return`<div style="text-align: center; padding: 10px; paddinng: 5px; margin-bottom: 20px; width: 100%">
    <h4>${p.title}</h4>
    <ul>
      <li>Total Cost : ${A}</li>
      <li>Payment Mode : ${p.payment_mode}</li>
      <li>Status : ${p.status}</li>
      <li>Created By : ${p.user}</li>
      <li>Created On : ${p.created_at}</li>
      </li>
    </ul>
  </div>`},Le=(h,p,A)=>{const P=Ue(h,A);Ie({header:P,repeatTableHeader:!0,printable:h,properties:p,type:"json",gridHeaderStyle:"font-weight: bold; border: 2px solid;",gridStyle:"border-collapse: collapse; border: 1px solid;"})};const M=h=>(Qe("data-v-c73e07d4"),h=h(),xe(),h),De={class:"q-pa-md"},Te={key:0},ze={key:1},Ee={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Fe={class:"text-center q-pa-xs",style:{"background-color":"#017951",color:"white"}},Oe={key:1,class:"text-center"},He={class:"text-center"},Re=M(()=>u("br",null,null,-1)),Ye=M(()=>u("br",null,null,-1)),je=M(()=>u("hr",null,null,-1)),Ge=M(()=>u("b",null,"Add Product",-1)),Je={key:0},Ke=M(()=>u("hr",null,null,-1)),We={class:"text-center error_msg"},Xe=M(()=>u("div",{class:"text-h6"},"Make Payment",-1)),Ze={class:"q-mt-sm"},el={key:2,class:"q-pa-sm"},ll={class:"row q-col-gutter-sm"},tl={class:"text-center error_msg"},al={__name:"Bills",setup(h){const p=Ae(),A=Be(),P=Ve(10),I=r(""),q=$e(),ne=Ne(),ie=Me(),Q=r(!1),c=r(!1),U=r(!0),L=r(!1),w=r(1),V=r(1),O=r(1),H=r(1),v=r(""),m=r(""),k=r(""),C=r(""),B=r([]),z=r([]),{data:X,isLoading:re,isError:Z}=W("bills",()=>q.fetchBills(),{onSuccess:s=>{z.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});W("products",()=>ne.fetchProducts(),{onSuccess:s=>{B.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:de}=W("payment_modes",()=>ie.fetchPaymentModes()),R=r(B.value),ce=s=>{v.value=s,Q.value=!0},E=ke(()=>{let s=0;return v.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),me=s=>{v.value=s,L.value=!0},pe=()=>{C.value="",Q.value=!1,m.value="",w.value=1,C.value=""},_e=async()=>{if(c.value=!0,v.value.sales.some(s=>s.name===m.value.name))C.value="Product already added to the bill",g("Product already added to the bill","red","top-right");else if(w.value>m.value.quantity)C.value=`${w.value} is more than the maximum available quantity`,g(`${w.value} is more than the maximum available quantity`,"red","top");else{const s=await q.addProductToBill({bill_uuid:v.value.uuid,uuid:m.value.uuid,name:m.value.name,selling_price:m.value.price,quantity:w.value});s.status=="success"?(p.refetchQueries("bills"),v.value="",Q.value=!1,c.value=!1,g(s.message,"green","top")):(c.value=!1,v.value="",Q.value=!1,g(s.message,"red","top"))}},fe=()=>{L.value=!1},ve=async s=>{if(c.value=!0,confirm("Are you sure?")){const e=await q.removeProductFromBill({product_uuid:s.uuid});e.status=="success"?(p.refetchQueries("bills"),c.value=!1,g(e.message,"green","top")):(v.value="",c.value=!1,roductQuantity.value=!1,g(e.message,"red","top"))}},ge=async s=>{if(c.value=!0,confirm("Are you sure?")){const e=await q.deleteBill({bill_uuid:s.uuid});e.status=="success"?(p.refetchQueries("bills"),c.value=!1,g(e.message,"green","top")):(c.value=!1,v.value="",Q.value=!1,g(e.message,"red","top"))}},ye=async()=>{c.value=!0;let s=[];v.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:v.value.uuid,products:s,payment_mode_uuid:k.value.uuid,bill_status:"sold"};if(k.value.name==="Mpesa & Cash"){const e=Number(O.value)+Number(H.value);l.selling_price=e,l.actual_selling_price=e}else U.value?(l.selling_price=Number(E.value),l.actual_selling_price=Number(E.value)):(l.selling_price=Number(E.value),l.actual_selling_price=Number(V.value));if(l.actual_selling_price&&l.payment_mode_uuid){const e=await q.updateSaleOperation(l);e.status==="success"?(p.refetchQueries("bills"),k.value="",w.value="",L.value=!1,c.value=!1,g(e.message,"green","top")):(C.value=e.message,g(e.message,"red","top-right"))}else c.value=!1,C.value="Name is required!",g("Name is required!","red","top-right")},be=(s,l)=>{s.length>0&&(B.value.includes(s)||B.value.push(s),l(s,"toggle"))},he=(s,l)=>{l(()=>{if(s==="")R.value=B.value;else{const e=s.toLowerCase();R.value=B.value.filter(o=>o.name.toLowerCase().indexOf(e)>-1)}})},ee=s=>{const l=[];s.sales.forEach(o=>{l.push({name:o.name,quantity:o.quantity,price:o.selling_price,total:o.quantity*o.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Le(l,["name","quantity","price","total"],e)},g=(s,l,e)=>{A.notify({message:s,color:l,position:e})};return(s,l)=>(n(),x("div",De,[S(re)?(n(),x("div",Te,"Loading bills...")):S(Z)?(n(),x("div",ze,"An error has occurred: "+i(S(Z)),1)):(n(),_(Pe,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:z.value,"row-key":"bill_ref",filter:I.value,pagination:S(P),"onUpdate:pagination":l[4]||(l[4]=e=>Ce(P)?P.value=e:null)},{"top-right":a(()=>[t(j,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(f,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>S(p).refetchQueries("bills"))}),t(f,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var o;return z.value=(o=S(X))==null?void 0:o.filter(D=>D.status==="sold")})}),t(f,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var o;return z.value=(o=S(X))==null?void 0:o.filter(D=>D.status==="pending")})})]),_:1}),t(T,{dense:"",debounce:"300",outlined:"",modelValue:I.value,"onUpdate:modelValue":l[3]||(l[3]=e=>I.value=e),placeholder:"Search"},{append:a(()=>[t(Y,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[u("div",Ee,[t(K,{bordered:"",class:le(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[u("div",Fe,[u("small",null,[u("strong",null,[t(Y,{name:"description",style:{"margin-bottom":"2px"}}),d(" BILL-"+i(e.row.bill_ref),1)])])]),t(N,null,{default:a(()=>[e.row.status==="pending"?(n(),_(G,{key:0},{default:a(()=>[u("strong",null," Created by : "+i(e.row.user),1),t($),t(j,null,{default:a(()=>[t(f,{round:"",size:"sm",color:"blue",icon:"add",onClick:o=>ce(e.row)},null,8,["onClick"]),t(f,{size:"sm",round:"",color:"red",icon:"delete",onClick:o=>ge(e.row),loading:c.value},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1024)):(n(),x("div",Oe,[u("strong",null," Created by : "+i(e.row.user),1),t($)])),t(J,{class:"q-mb-sm"}),u("div",He,[u("small",null,"Created On : "+i(e.row.created_at),1),d(),Re,u("small",null,[t(F,{color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[d("Status : "+i(e.row.status)+" ",1),Ye,d(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"])])]),t(J,{class:"q-mb-sm"}),u("small",null,[t(oe,{dense:"",bordered:"",separator:"",class:"bill"},{default:a(()=>[t(ue,null,{default:a(()=>[t(b,null,{default:a(()=>[d("Name")]),_:1}),t(b,null,{default:a(()=>[d("Price")]),_:1}),t(b,{style:{color:"white"}},{default:a(()=>[d("Quantity")]),_:1}),t(b,{style:{color:"white"}},{default:a(()=>[d("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(n(),_(b,{key:0},{default:a(()=>[d("Action")]),_:1})):y("",!0)]),_:2},1024)]),_:2},1024)]),t(oe,{dense:"",bordered:"",separator:""},{default:a(()=>[(n(!0),x(Se,null,qe(e.row.sales,(o,D)=>(n(),_(ue,{key:D},{default:a(()=>[t(b,null,{default:a(()=>[d(i(o.name),1)]),_:2},1024),t(b,null,{default:a(()=>[d(i(o.selling_price),1)]),_:2},1024),t(b,null,{default:a(()=>[d(i(o.quantity),1)]),_:2},1024),t(b,null,{default:a(()=>[d(i(o.quantity*o.selling_price),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(n(),_(b,{key:0},{default:a(()=>[t(Y,{name:"delete",color:"red",onClick:sl=>ve(o),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):y("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),t(J),e.row.selling_price>0?(n(),_(N,{key:0,class:"flex flex-center"},{default:a(()=>[u("b",null,"Price Ksh "+i(e.row.selling_price),1)]),_:2},1024)):y("",!0),je,t(N,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(n(),_(f,{key:0,class:"full-width",dense:"",flat:"",onClick:o=>ee(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"])):(n(),_(j,{key:1,class:"full-width"},{default:a(()=>[t(f,{class:"full-width",dense:"",flat:"",onClick:o=>ee(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(f,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:o=>me(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),t(te,{modelValue:Q.value,"onUpdate:modelValue":l[7]||(l[7]=e=>Q.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(N,null,{default:a(()=>[t(G,null,{default:a(()=>[Ge,t($),m.value?(n(),x("small",Je,[t(F,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Price: "+i(m.value.price),1)]),_:1}),t(F,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Category: "+i(m.value.category),1)]),_:1}),t(F,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Department: "+i(m.value.department),1)]),_:1})])):y("",!0)]),_:1}),Ke,t(ae,{dense:"","use-input":"",outlined:"",modelValue:m.value,"onUpdate:modelValue":l[5]||(l[5]=e=>m.value=e),"input-debounce":"0",onNewValue:be,options:R.value,onFilter:he,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t(N,{class:"q-pt-none"},{default:a(()=>[m.value?(n(),_(T,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:w.value,"onUpdate:modelValue":l[6]||(l[6]=e=>w.value=e),type:"number",hint:`Note : You can sale a maximum of ${m.value.quantity}`},null,8,["modelValue","hint"])):y("",!0)]),_:1}),u("div",We,[u("small",null,i(C.value),1)]),t(se,{align:"right"},{default:a(()=>[t(f,{flat:"",label:"Cancel",color:"red",onClick:pe}),t($),w.value&&m.value?(n(),_(f,{key:0,flat:"",label:"Add Product",color:"primary",onClick:_e,loading:c.value},null,8,["loading"])):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:L.value,"onUpdate:modelValue":l[13]||(l[13]=e=>L.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(G,null,{default:a(()=>[Xe,t($),u("small",Ze,[t(f,{disabled:k.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:le(`${U.value?"":"actual_selling_price"}`),onClick:l[8]||(l[8]=e=>U.value=!U.value),label:`Expected Selling Price : ${E.value}`},null,8,["disabled","class","label"])])]),_:1}),t(N,{class:"q-pt-none"},{default:a(()=>[!U.value&&k.value.name!=="Mpesa & Cash"?(n(),_(T,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:V.value,"onUpdate:modelValue":l[9]||(l[9]=e=>V.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):y("",!0),V.value&&V.value>0?(n(),_(ae,{key:1,dense:"",outlined:"",modelValue:k.value,"onUpdate:modelValue":l[10]||(l[10]=e=>k.value=e),options:S(de),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):y("",!0),k.value.name==="Mpesa & Cash"?(n(),x("div",el,[u("div",ll,[t(T,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:O.value,"onUpdate:modelValue":l[11]||(l[11]=e=>O.value=e)},null,8,["modelValue"]),t(T,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:H.value,"onUpdate:modelValue":l[12]||(l[12]=e=>H.value=e)},null,8,["modelValue"])])])):y("",!0)]),_:1}),u("div",tl,[u("small",null,i(C.value),1)]),t(se,{align:"right"},{default:a(()=>[t(f,{flat:"",label:"Cancel",color:"red",onClick:fe}),t($),V.value&&k.value?(n(),_(f,{key:0,flat:"",label:"Sale",color:"primary",onClick:ye,loading:c.value},null,8,["loading"])):y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var Cl=we(al,[["__scopeId","data-v-c73e07d4"]]);export{Cl as default};
