import{c4 as Se,r,c as Qe,aI as n,a5 as f,u as P,P as i,a3 as p,bb as a,b as Be,d as t,bE as c,bD as W,a6 as o,M as H,ac as d,a4 as b,F as ue,aO as ne,aL as $e,aJ as De}from"./index.54629b9a.js";import{Q as X}from"./QBtnGroup.632ef586.js";import{Q as D}from"./QInput.92598606.js";import{Q as Ne,c as Z,p as Me,d as V,e as ie,f as ee}from"./paginations.53f48ad5.js";import{a as O,Q as I}from"./QBadge.77ac399d.js";import{Q as le}from"./QSeparator.d04c4ca5.js";import{p as re,n as de,o as w}from"./rtl.5467f1aa.js";import{Q as x,a as K}from"./QCard.a98f9a97.js";import{a as Ae}from"./use-quasar.8acf90c1.js";import{a as Ue,u as te}from"./index.da8d9231.js";import{u as Ie}from"./sale-store.cec967d1.js";import{u as Le}from"./product-store.244076f2.js";import{u as ze}from"./payment-mode-store.7be13951.js";import{e as Te}from"./receipt.a2190c3f.js";import"./use-dark.f6381175.js";import"./module_calls.c637478d.js";import"./helpers.d60dad50.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const q=L=>($e("data-v-4a33c954"),L=L(),De(),L),Ee={class:"q-pa-md"},Fe={key:0},He={key:1},Oe={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Ke={key:1,class:"text-center"},Re={class:"text-center"},Ye=q(()=>o("br",null,null,-1)),Ge=q(()=>o("br",null,null,-1)),Je=q(()=>o("br",null,null,-1)),je={key:0},We=q(()=>o("br",null,null,-1)),Xe={key:1},Ze={key:2},el=q(()=>o("hr",null,null,-1)),ll=q(()=>o("b",null,"Add Product",-1)),tl={key:0},al=q(()=>o("hr",null,null,-1)),sl={class:"text-center error_msg"},ol=q(()=>o("div",{class:"text-h6"},"Make Payment",-1)),ul={class:"q-mt-sm"},nl={key:2,class:"q-pa-sm"},il={class:"row q-col-gutter-sm"},rl={key:3,class:"q-pa-sm"},dl={class:"text-center error_msg"},cl={border:"1",style:{width:"100%","border-collapse":"collapse"}},ml=q(()=>o("tr",null,[o("th",{class:"text-center q-pa-sm"},"Amount Paid"),o("th",{class:"text-center q-pa-sm"},"Balance"),o("th",{class:"text-center q-pa-sm"},"Mode"),o("th",{class:"text-center q-pa-sm"},"Cleared By"),o("th",{class:"text-center q-pa-sm"},"Cleared On")],-1)),_l={class:"text-center q-pa-sm"},pl={class:"text-center q-pa-sm"},fl={class:"text-center q-pa-sm"},vl={class:"text-center q-pa-sm"},bl={class:"text-center q-pa-sm"},yl={__name:"Bills",setup(L){const N=Ue(),ce=Ae(),R=Me(10),Y=r(""),M=Ie(),me=Le(),_e=ze(),C=r(!1),m=r(!1),z=r(!1),S=r(""),A=r(!0),U=r(!1),k=r(1),Q=r(1),G=r(1),J=r(1),T=r(""),y=r(""),_=r(""),v=r(""),h=r(""),B=r([]),E=r([]),{data:ae,isLoading:pe,isError:se}=te("bills",()=>M.fetchBills(),{onSuccess:s=>{E.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,debtor_name:l.debtor_name,total_debt_paid:l.total_debt_paid,debt_records:l.debt_records,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});te("products",()=>me.fetchProducts(),{onSuccess:s=>{B.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:fe}=te("payment_modes",()=>_e.fetchPaymentModes()),j=r(B.value),ve=s=>{y.value=s,C.value=!0},be=s=>{S.value=s,z.value=!0},ye=()=>{S.value="",z.value=!1},F=Qe(()=>{let s=0;return y.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),ge=s=>{y.value=s,U.value=!0},he=()=>{h.value="",C.value=!1,_.value="",k.value=1,h.value=""},we=async()=>{if(m.value=!0,y.value.sales.some(s=>s.name===_.value.name))h.value="Product already added to the bill",g("Product already added to the bill","red","top-right");else if(k.value>_.value.quantity)h.value=`${k.value} is more than the maximum available quantity`,g(`${k.value} is more than the maximum available quantity`,"red","top");else{const s=await M.addProductToBill({bill_uuid:y.value.uuid,uuid:_.value.uuid,name:_.value.name,selling_price:_.value.price,quantity:k.value});s.status=="success"?(N.refetchQueries("bills"),y.value="",C.value=!1,m.value=!1,g(s.message,"green","top")):(m.value=!1,y.value="",C.value=!1,g(s.message,"red","top"))}},ke=()=>{U.value=!1,v.value="",h.value=""},qe=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await M.removeProductFromBill({product_uuid:s.uuid});e.status=="success"?(N.refetchQueries("bills"),m.value=!1,g(e.message,"green","top")):(y.value="",m.value=!1,C.value=!1,g(e.message,"red","top"))}},Ce=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await M.deleteBill({bill_uuid:s.uuid});e.status=="success"?(N.refetchQueries("bills"),m.value=!1,g(e.message,"green","top")):(m.value=!1,y.value="",C.value=!1,g(e.message,"red","top"))}},Pe=async()=>{m.value=!0;let s=[];y.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:y.value.uuid,products:s,payment_mode_uuid:v.value.uuid,bill_status:"sold",debtor_name:T.value.trim()};if(v.value.name==="Mpesa & Cash"){const e=Number(G.value)+Number(J.value);l.selling_price=e,l.actual_selling_price=e}else A.value?(l.selling_price=Number(F.value),l.actual_selling_price=Number(F.value)):(l.selling_price=Number(F.value),l.actual_selling_price=Number(Q.value));if(l.actual_selling_price&&l.payment_mode_uuid)if(v.value.name==="Debt"&&!T.value)alert("Debtor name is required."),h.value="Debtor name is required.",m.value=!1;else{const e=await M.updateSaleOperation(l);e.status==="success"?(N.refetchQueries("bills"),v.value="",k.value="",U.value=!1,m.value=!1,g(e.message,"green","top")):(h.value=e.message,g(e.message,"red","top-right"))}else m.value=!1,h.value="Name is required!",g("Name is required!","red","top-right")},Ve=(s,l)=>{s.length>0&&(B.value.includes(s)||B.value.push(s),l(s,"toggle"))},xe=(s,l)=>{l(()=>{if(s==="")j.value=B.value;else{const e=s.toLowerCase();j.value=B.value.filter(u=>u.name.toLowerCase().indexOf(e)>-1)}})},oe=s=>{const l=[];s.sales.forEach(u=>{l.push({name:u.name,quantity:u.quantity,price:u.selling_price,total:u.quantity*u.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};Te(l,["name","quantity","price","total"],e)},g=(s,l,e)=>{ce.notify({message:s,color:l,position:e})};return(s,l)=>(n(),f("div",Ee,[P(pe)?(n(),f("div",Fe,"Loading bills...")):P(se)?(n(),f("div",He,"An error has occurred: "+i(P(se)),1)):(n(),p(Ne,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:E.value,"row-key":"bill_ref",filter:Y.value,pagination:P(R),"onUpdate:pagination":l[4]||(l[4]=e=>Be(R)?R.value=e:null)},{"top-right":a(()=>[t(X,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(c,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>P(N).refetchQueries("bills"))}),t(c,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var u;return E.value=(u=P(ae))==null?void 0:u.filter($=>$.status==="sold")})}),t(c,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var u;return E.value=(u=P(ae))==null?void 0:u.filter($=>$.status==="pending")})}),t(c,{icon:"pan_tool",size:"sm",color:"orange",label:"Clear Bills",to:"/clear_bills"})]),_:1}),t(D,{dense:"",debounce:"300",outlined:"",modelValue:Y.value,"onUpdate:modelValue":l[3]||(l[3]=e=>Y.value=e),placeholder:"Search"},{append:a(()=>[t(W,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[o("div",Oe,[t(K,{bordered:"",class:H(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[o("div",{class:H(["text-center q-pa-xs",`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[o("small",null,[o("strong",null,[t(W,{name:"description",style:{"margin-bottom":"2px"}}),d(" BILL-"+i(e.row.bill_ref),1)])])],2),t(x,null,{default:a(()=>[e.row.status==="pending"?(n(),p(O,{key:0},{default:a(()=>[o("strong",null," Created by : "+i(e.row.user),1),t(V),t(X,null,{default:a(()=>[t(c,{round:"",size:"sm",color:"blue",icon:"add",onClick:u=>ve(e.row)},null,8,["onClick"]),t(c,{size:"sm",round:"",color:"red",icon:"delete",onClick:u=>Ce(e.row),loading:m.value},null,8,["onClick","loading"])]),_:2},1024)]),_:2},1024)):(n(),f("div",Ke,[o("strong",null," Created by : "+i(e.row.user),1),t(V)])),t(le,{class:"q-mb-sm"}),o("div",Re,[o("small",null,"Created On : "+i(e.row.created_at),1),d(),Ye,o("small",null,[e.row.payment_mode==="Debt"?(n(),p(I,{key:0,color:"blue"},{default:a(()=>[d("Status : "+i(e.row.status)+" ",1),Ge,d(" Mode : "+i(e.row.payment_mode),1)]),_:2},1024)):(n(),p(I,{key:1,color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[d("Status : "+i(e.row.status)+" ",1),Je,d(" Mode : "+i(e.row.payment_mode),1)]),_:2},1032,["color"]))])]),t(le,{class:"q-mb-sm"}),o("small",null,[t(re,{dense:"",bordered:"",separator:"",class:H(`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`)},{default:a(()=>[t(de,null,{default:a(()=>[t(w,null,{default:a(()=>[d("Name")]),_:1}),t(w,null,{default:a(()=>[d("Price")]),_:1}),t(w,{style:{color:"white"}},{default:a(()=>[d("Quantity")]),_:1}),t(w,{style:{color:"white"}},{default:a(()=>[d("Total")]),_:1}),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(w,{key:0},{default:a(()=>[d("Action")]),_:1})):b("",!0)]),_:2},1024)]),_:2},1032,["class"])]),t(re,{dense:"",bordered:"",separator:""},{default:a(()=>[(n(!0),f(ue,null,ne(e.row.sales,(u,$)=>(n(),p(de,{key:$},{default:a(()=>[t(w,null,{default:a(()=>[d(i(u.name),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i(u.selling_price),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i(u.quantity),1)]),_:2},1024),t(w,null,{default:a(()=>[d(i(u.quantity*u.selling_price),1)]),_:2},1024),e.row.status==="pending"&&e.row.sales.length>1?(n(),p(w,{key:0},{default:a(()=>[t(W,{name:"delete",color:"red",onClick:gl=>qe(u),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):b("",!0)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),t(le),e.row.selling_price>0?(n(),p(x,{key:0,class:"text-center"},{default:a(()=>{var u;return[e.row.payment_mode==="Debt"?(n(),f("p",je,[d(" Debtor: "+i(e.row.debtor_name)+" ",1),We,o("b",null,"Amount due Ksh "+i(e.row.selling_price),1)])):(n(),f("b",Xe,"Price Ksh "+i(e.row.selling_price),1)),((u=e.row.debt_records)==null?void 0:u.length)>0?(n(),f("p",Ze,[t(c,{flat:"",size:"sm",label:"Click to View Payment History",color:"orange",onClick:$=>be(e.row)},null,8,["onClick"])])):b("",!0)]}),_:2},1024)):b("",!0),el,t(x,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(n(),p(c,{key:0,class:"full-width",dense:"",flat:"",onClick:u=>oe(e.row),label:"Print Bill",icon:"print",color:`${e.row.payment_mode==="Debt"?"blue":"primary"}`},null,8,["onClick","color"])):(n(),p(X,{key:1,class:"full-width"},{default:a(()=>[t(c,{class:"full-width",dense:"",flat:"",onClick:u=>oe(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(c,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:u=>ge(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),t(Z,{modelValue:C.value,"onUpdate:modelValue":l[7]||(l[7]=e=>C.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(x,null,{default:a(()=>[t(O,null,{default:a(()=>[ll,t(V),_.value?(n(),f("small",tl,[t(I,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Price: "+i(_.value.price),1)]),_:1}),t(I,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Category: "+i(_.value.category),1)]),_:1}),t(I,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Department: "+i(_.value.department),1)]),_:1})])):b("",!0)]),_:1}),al,t(ie,{dense:"","use-input":"",outlined:"",modelValue:_.value,"onUpdate:modelValue":l[5]||(l[5]=e=>_.value=e),"input-debounce":"0",onNewValue:Ve,options:j.value,onFilter:xe,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t(x,{class:"q-pt-none"},{default:a(()=>[_.value?(n(),p(D,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:k.value,"onUpdate:modelValue":l[6]||(l[6]=e=>k.value=e),type:"number",hint:`Note : You can sale a maximum of ${_.value.quantity}`},null,8,["modelValue","hint"])):b("",!0)]),_:1}),o("div",sl,[o("small",null,i(h.value),1)]),t(ee,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:he}),t(V),k.value&&_.value?(n(),p(c,{key:0,flat:"",label:"Add Product",color:"primary",onClick:we,loading:m.value},null,8,["loading"])):b("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Z,{modelValue:U.value,"onUpdate:modelValue":l[14]||(l[14]=e=>U.value=e),persistent:""},{default:a(()=>[t(K,{style:{width:"500px"}},{default:a(()=>[t(O,null,{default:a(()=>[ol,t(V),o("small",ul,[t(c,{disabled:v.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:H(`${A.value?"":"actual_selling_price"}`),onClick:l[8]||(l[8]=e=>A.value=!A.value),label:`Expected Selling Price : ${F.value}`},null,8,["disabled","class","label"])])]),_:1}),t(x,{class:"q-pt-none"},{default:a(()=>[!A.value&&v.value.name!=="Mpesa & Cash"?(n(),p(D,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:Q.value,"onUpdate:modelValue":l[9]||(l[9]=e=>Q.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):b("",!0),Q.value&&Q.value>0?(n(),p(ie,{key:1,dense:"",outlined:"",modelValue:v.value,"onUpdate:modelValue":l[10]||(l[10]=e=>v.value=e),options:P(fe),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):b("",!0),v.value.name==="Mpesa & Cash"?(n(),f("div",nl,[o("div",il,[t(D,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:G.value,"onUpdate:modelValue":l[11]||(l[11]=e=>G.value=e)},null,8,["modelValue"]),t(D,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:J.value,"onUpdate:modelValue":l[12]||(l[12]=e=>J.value=e)},null,8,["modelValue"])])])):b("",!0),v.value.name==="Debt"?(n(),f("div",rl,[t(D,{outlined:"",modelValue:T.value,"onUpdate:modelValue":l[13]||(l[13]=e=>T.value=e),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):b("",!0)]),_:1}),o("div",dl,[o("small",null,i(h.value),1)]),t(ee,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:ke}),t(V),Q.value&&v.value?(n(),p(c,{key:0,flat:"",label:"Sale",color:"primary",onClick:Pe,loading:m.value},null,8,["loading"])):b("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Z,{modelValue:z.value,"onUpdate:modelValue":l[16]||(l[16]=e=>z.value=e),persistent:""},{default:a(()=>[t(K,null,{default:a(()=>[t(O,{class:"bg-orange text-white q-mb-sm"},{default:a(()=>[o("b",null,"Payment History for BILL-"+i(S.value.bill_ref)+". ",1),t(V),o("b",null,"Name: "+i(S.value.debtor_name)+". ",1)]),_:1}),t(x,{class:"q-pt-none"},{default:a(()=>[o("small",null,[o("table",cl,[ml,(n(!0),f(ue,null,ne(S.value.debt_records,e=>(n(),f("tr",{key:e.uuid},[o("td",_l,i(e.amount_paid),1),o("td",pl,i(e.balance),1),o("td",fl,i(e.payment_mode),1),o("td",vl,i(e.user),1),o("td",bl,i(e.created_at),1)]))),128))])])]),_:1}),t(ee,null,{default:a(()=>[t(c,{dense:"",flat:"",label:`Total Paid: ${S.value.total_debt_paid}`,color:"primary",disabled:""},null,8,["label"]),t(V),t(c,{dense:"",outline:"",label:"Close History",color:"primary",onClick:l[15]||(l[15]=e=>ye())})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var zl=Se(yl,[["__scopeId","data-v-4a33c954"]]);export{zl as default};
