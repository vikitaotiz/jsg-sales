import{c4 as me,r,c as _e,aI as c,a5 as f,u as D,P as o,a3 as b,bb as t,b as fe,d as a,bE as h,bD as X,a6 as u,M as E,ac as s,a4 as p,F as Y,aO as Z,aL as be,aJ as pe}from"./index.0fcaefe8.js";import{Q as ee}from"./QBtnGroup.f5010ab3.js";import{Q as C}from"./QInput.79a1560c.js";import{Q as ye,c as ge,p as ve,d as T,e as he,f as we}from"./paginations.191f847e.js";import{Q as N}from"./QSeparator.0c310cd3.js";import{Q as qe,a as Ce}from"./QBadge.307759ef.js";import{p as M,n as Q,o as i}from"./rtl.b5227362.js";import{Q as k,a as le}from"./QCard.8e472192.js";import{a as Qe}from"./use-quasar.484de5c5.js";import{u as ke}from"./sale-store.949fb3a5.js";import{u as Ve}from"./product-store.124e71bc.js";import{u as Se}from"./payment-mode-store.a4f850b3.js";import{a as xe,u as z}from"./index.8dceaa5d.js";import{e as Be}from"./receipt.a2190c3f.js";import"./use-dark.d82e8b53.js";import"./module_calls.8cce7b79.js";import"./helpers.185a9004.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const V=S=>(be("data-v-e3da76a0"),S=S(),pe(),S),Pe={class:"q-pa-md"},De={key:0},Ne={key:1},Me={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Ie={class:"text-center"},Ue={class:"text-center"},Ae=V(()=>u("br",null,null,-1)),$e=V(()=>u("br",null,null,-1)),Le=V(()=>u("b",null,"Payment Records (Partially Paid)",-1)),Ee=V(()=>u("br",null,null,-1)),Te={key:0},ze=V(()=>u("div",{class:"text-h6"},"Make Payment",-1)),Fe={class:"q-mt-sm"},Re={key:2,class:"q-pa-sm"},Ke={class:"row q-col-gutter-sm"},Oe={key:3,class:"q-pa-sm"},Ge={class:"text-center error_msg"},Je={__name:"ClearBills",setup(S){const ae=xe(),te=Qe(),I=ve(10),U=r(""),F=ke(),se=Ve(),ue=Se();r(!1);const x=r(!1),w=r(!0),q=r(!1),ne=r(1),y=r(1),A=r(1),$=r(1),R=r(""),g=r("");r("");const m=r(""),B=r(""),K=r([]),O=r([]),{data:je,isLoading:oe,isError:G}=z("bills",()=>F.fetchUnclearedBills(),{onSuccess:n=>{O.value=n.map(e=>({user:e.user,uuid:e.uuid,bill_ref:e.bill_ref,debtor_name:e.debtor_name,debtors:e.debtors,total_debt_paid:e.total_debt_paid,status:e.status,payment_mode:e.payment_mode,selling_price:e.selling_price,actual_selling_price:e.actual_selling_price,created_at:e.created_at,sales:e.sales}))}});z("products",()=>se.fetchProducts(),{onSuccess:n=>{K.value=n.map(e=>({uuid:e.uuid,name:e.name,price:e.selling_price,category:e.category,department:e.department,quantity:e.quantity}))}});const J=r([]);z("payment_modes",()=>ue.fetchPaymentModes(),{onSuccess:n=>J.value=n.filter(e=>e.name!=="Debt")}),r(K.value);const P=_e(()=>{let n=0;return g.value.sales.forEach(e=>{n+=e.selling_price*e.quantity}),n=n-g.value.total_debt_paid,n}),ie=n=>{g.value=n,q.value=!0},de=()=>{q.value=!1,m.value="",B.value=""},re=async()=>{x.value=!0;let n=[];g.value.sales.forEach(l=>n.push({name:l.name,quantity:l.quantity,uuid:l.uuid}));const e={bill_uuid:g.value.uuid,payment_mode_uuid:m.value.uuid,debtor_name:g.value.debtor_name};if(m.value.name==="Mpesa & Cash"){const l=Number(A.value)+Number($.value);e.selling_price=l,e.actual_selling_price=l}else w.value?(e.selling_price=Number(P.value),e.actual_selling_price=Number(P.value)):(e.selling_price=Number(P.value),e.actual_selling_price=Number(y.value));if(e.actual_selling_price===e.selling_price?e.balance=0:e.balance=e.selling_price-e.actual_selling_price,e.actual_selling_price&&e.payment_mode_uuid&&e.debtor_name){const l=await F.payUnclearedBill(e);l.status==="success"?(ae.refetchQueries("bills"),m.value="",ne.value="",q.value=!1,x.value=!1,L(l.message,"green","top")):(B.value=l.message,L(l.message,"red","top-right"))}else x.value=!1,B.value="Name is required!",L("Name is required!","red","top-right")},ce=n=>{const e=[];n.sales.forEach(_=>{e.push({name:_.name,quantity:_.quantity,price:_.selling_price,total:_.quantity*_.selling_price})});const l={title:"Sales Receipt",status:n.status==="sold"?"Sold":"Pending Payment",user:n.user,payment_mode:n.payment_mode};Be(e,["name","quantity","price","total"],l)},L=(n,e,l)=>{te.notify({message:n,color:e,position:l})};return(n,e)=>(c(),f("div",Pe,[D(oe)?(c(),f("div",De,"Loading bills...")):D(G)?(c(),f("div",Ne,"An error has occurred: "+o(D(G)),1)):(c(),b(ye,{key:2,grid:"",flat:"",bordered:"",title:"Uncleared Bills",rows:O.value,"row-key":"bill_ref",filter:U.value,pagination:D(I),"onUpdate:pagination":e[1]||(e[1]=l=>fe(I)?I.value=l:null)},{"top-right":t(()=>[a(ee,{class:"q-mr-sm q-mb-sm"},{default:t(()=>[a(h,{icon:"list",size:"sm",color:"primary",label:"All Bills",to:"/bills"})]),_:1}),a(C,{dense:"",debounce:"300",outlined:"",modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),placeholder:"Search"},{append:t(()=>[a(X,{name:"search"})]),_:1},8,["modelValue"])]),item:t(l=>[u("div",Me,[a(le,{bordered:"",class:E(`${l.row.status=="pending"?"sale_pending":""}`)},{default:t(()=>{var _,j;return[u("div",{class:E(["text-center q-pa-xs",`${l.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[u("small",null,[u("strong",null,[a(X,{name:"description",style:{"margin-bottom":"2px"}}),s(" BILL-"+o(l.row.bill_ref),1)])])],2),a(k,null,{default:t(()=>[u("div",Ie,[u("strong",null," Created by : "+o(l.row.user),1),a(T)]),a(N,{class:"q-mb-sm"}),u("div",Ue,[u("small",null,"Created On : "+o(l.row.created_at),1),s(),Ae,u("small",null,[a(qe,{color:"blue"},{default:t(()=>[s("Status : "+o(l.row.status)+" ",1),$e,s(" Mode : "+o(l.row.payment_mode),1)]),_:2},1024)])]),a(N,{class:"q-mb-sm"}),u("small",null,[a(M,{dense:"",bordered:"",separator:"",class:"debt_bill"},{default:t(()=>[a(Q,null,{default:t(()=>[a(i,null,{default:t(()=>[s("Name")]),_:1}),a(i,null,{default:t(()=>[s("Price")]),_:1}),a(i,{style:{color:"white"}},{default:t(()=>[s("Quantity")]),_:1}),a(i,{style:{color:"white"}},{default:t(()=>[s("Total")]),_:1}),l.row.status==="pending"&&l.row.sales.length>1?(c(),b(i,{key:0},{default:t(()=>[s("Action")]),_:1})):p("",!0)]),_:2},1024)]),_:2},1024)]),a(M,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),f(Y,null,Z(l.row.sales,(d,v)=>(c(),b(Q,{key:v},{default:t(()=>[a(i,null,{default:t(()=>[s(o(d.name),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.selling_price),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.quantity),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.quantity*d.selling_price),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),a(N),((j=(_=l==null?void 0:l.row)==null?void 0:_.debtors)==null?void 0:j.length)>0?(c(),b(k,{key:0},{default:t(()=>[u("small",null,[Le,a(M,{dense:"",bordered:"",separator:""},{default:t(()=>[a(Q,null,{default:t(()=>[a(i,null,{default:t(()=>[s("Paid")]),_:1}),a(i,null,{default:t(()=>[s("Balance")]),_:1}),a(i,null,{default:t(()=>[s("Mode")]),_:1}),a(i,null,{default:t(()=>[s("Date")]),_:1})]),_:1})]),_:1}),a(M,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),f(Y,null,Z(l.row.debtors,(d,v)=>(c(),b(Q,{key:v},{default:t(()=>[a(i,null,{default:t(()=>[s(o(d.amount_paid),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.balance),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.payment_mode),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.created_at),1)]),_:2},1024)]),_:2},1024))),128)),a(Q,{class:"bg-indigo text-white"},{default:t(()=>[a(i,null,{default:t(()=>[s("Total Debt Cleared")]),_:1}),a(i,null,{default:t(()=>{var d;return[s(o((d=l==null?void 0:l.row)==null?void 0:d.total_debt_paid),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):p("",!0),a(N),a(k,{class:"text-center"},{default:t(()=>{var d,v,H,W;return[u("small",null,[u("p",null,"Debtor: "+o(l.row.debtor_name),1),u("b",null,"Initial Debt Ksh "+o((d=l==null?void 0:l.row)==null?void 0:d.selling_price),1),s(),Ee,((v=l==null?void 0:l.row)==null?void 0:v.total_debt_paid)>0?(c(),f("b",Te,"Amount due Ksh "+o(((H=l==null?void 0:l.row)==null?void 0:H.selling_price)-((W=l==null?void 0:l.row)==null?void 0:W.total_debt_paid)),1)):p("",!0)])]}),_:2},1024),a(k,{style:{padding:"0"}},{default:t(()=>[a(ee,{class:"full-width"},{default:t(()=>[a(h,{class:"full-width",dense:"",flat:"",onClick:d=>ce(l.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),a(h,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Clear Bill",icon:"grain",onClick:d=>ie(l.row)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]}),_:2},1032,["class"])])]),_:1},8,["rows","filter","pagination"])),a(ge,{modelValue:q.value,"onUpdate:modelValue":e[8]||(e[8]=l=>q.value=l),persistent:""},{default:t(()=>[a(le,{style:{width:"500px"}},{default:t(()=>[a(Ce,null,{default:t(()=>[ze,a(T),u("small",Fe,[a(h,{disabled:m.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:E(`${w.value?"":"actual_selling_price"}`),onClick:e[2]||(e[2]=l=>w.value=!w.value),label:`Full payment : ${P.value}`},null,8,["disabled","class","label"])])]),_:1}),a(k,{class:"q-pt-none"},{default:t(()=>[!w.value&&m.value.name!=="Mpesa & Cash"?(c(),b(C,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual amount paid",modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=l=>y.value=l),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):p("",!0),y.value&&y.value>0?(c(),b(he,{key:1,dense:"",outlined:"",modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=l=>m.value=l),options:J.value,"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):p("",!0),m.value.name==="Mpesa & Cash"?(c(),f("div",Re,[u("div",Ke,[a(C,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=l=>A.value=l)},null,8,["modelValue"]),a(C,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:$.value,"onUpdate:modelValue":e[6]||(e[6]=l=>$.value=l)},null,8,["modelValue"])])])):p("",!0),m.value.name==="Debt"?(c(),f("div",Oe,[a(C,{outlined:"",modelValue:R.value,"onUpdate:modelValue":e[7]||(e[7]=l=>R.value=l),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):p("",!0)]),_:1}),u("div",Ge,[u("small",null,o(B.value),1)]),a(we,{align:"right"},{default:t(()=>[a(h,{flat:"",label:"Cancel",color:"red",onClick:de}),a(T),y.value&&m.value?(c(),b(h,{key:0,flat:"",label:"Pay",color:"primary",onClick:re,loading:x.value},null,8,["loading"])):p("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var fl=me(Je,[["__scopeId","data-v-e3da76a0"]]);export{fl as default};
