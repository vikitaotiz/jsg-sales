import{c4 as ce,r,c as me,aI as c,a5 as f,u as $,P as o,a3 as b,bb as t,d as a,bE as h,bD as W,a6 as u,M as L,ac as s,a4 as p,F as X,aO as Y,aL as _e,aJ as fe}from"./index.104f6ae1.js";import{Q as Z}from"./QBtnGroup.fcc107dc.js";import{Q as C}from"./QInput.2343ca30.js";import{Q as be,c as pe,d as E,e as ye,f as ge}from"./QCardActions.e5ce3c72.js";import{Q as D}from"./QSeparator.66c9c541.js";import{Q as ve,a as he}from"./QBadge.e5611531.js";import{p as N,n as Q,o as i}from"./rtl.9bf9d968.js";import{Q as k,a as ee}from"./QCard.4f99fc1d.js";import{a as we}from"./use-quasar.f532f3dd.js";import{u as qe}from"./sale-store.c83f31eb.js";import{u as Ce}from"./product-store.c13069a5.js";import{u as Qe}from"./payment-mode-store.19fa488f.js";import{a as ke,u as T}from"./index.3178a3ef.js";import{e as Ve}from"./receipt.a2190c3f.js";import"./use-dark.abb6de42.js";import"./module_calls.c637478d.js";import"./helpers.d60dad50.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const V=S=>(_e("data-v-845e10e8"),S=S(),fe(),S),Se={class:"q-pa-md"},xe={key:0},Be={key:1},Pe={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},De={class:"text-center"},Ne={class:"text-center"},Me=V(()=>u("br",null,null,-1)),Ie=V(()=>u("br",null,null,-1)),Ue=V(()=>u("b",null,"Payment Records (Partially Paid)",-1)),Ae=V(()=>u("br",null,null,-1)),$e={key:0},Le=V(()=>u("div",{class:"text-h6"},"Make Payment",-1)),Ee={class:"q-mt-sm"},Te={key:2,class:"q-pa-sm"},Fe={class:"row q-col-gutter-sm"},ze={key:3,class:"q-pa-sm"},Ke={class:"text-center error_msg"},Oe={__name:"ClearBills",setup(S){const le=ke(),ae=we(),M=r(""),F=qe(),te=Ce(),se=Qe();r(!1);const x=r(!1),w=r(!0),q=r(!1),ue=r(1),y=r(1),I=r(1),U=r(1),z=r(""),g=r("");r("");const m=r(""),B=r(""),K=r([]),O=r([]),{data:Re,isLoading:ne,isError:R}=T("bills",()=>F.fetchUnclearedBills(),{onSuccess:n=>{O.value=n.map(e=>({user:e.user,uuid:e.uuid,bill_ref:e.bill_ref,debtor_name:e.debtor_name,debtors:e.debtors,total_debt_paid:e.total_debt_paid,status:e.status,payment_mode:e.payment_mode,selling_price:e.selling_price,actual_selling_price:e.actual_selling_price,created_at:e.created_at,sales:e.sales}))}});T("products",()=>te.fetchProducts(),{onSuccess:n=>{K.value=n.map(e=>({uuid:e.uuid,name:e.name,price:e.selling_price,category:e.category,department:e.department,quantity:e.quantity}))}});const G=r([]);T("payment_modes",()=>se.fetchPaymentModes(),{onSuccess:n=>G.value=n.filter(e=>e.name!=="Debt")}),r(K.value);const P=me(()=>{let n=0;return g.value.sales.forEach(e=>{n+=e.selling_price*e.quantity}),n=n-g.value.total_debt_paid,n}),oe=n=>{g.value=n,q.value=!0},ie=()=>{q.value=!1,m.value="",B.value=""},de=async()=>{x.value=!0;let n=[];g.value.sales.forEach(l=>n.push({name:l.name,quantity:l.quantity,uuid:l.uuid}));const e={bill_uuid:g.value.uuid,payment_mode_uuid:m.value.uuid,debtor_name:g.value.debtor_name};if(m.value.name==="Mpesa & Cash"){const l=Number(I.value)+Number(U.value);e.selling_price=l,e.actual_selling_price=l}else w.value?(e.selling_price=Number(P.value),e.actual_selling_price=Number(P.value)):(e.selling_price=Number(P.value),e.actual_selling_price=Number(y.value));if(e.actual_selling_price===e.selling_price?e.balance=0:e.balance=e.selling_price-e.actual_selling_price,e.actual_selling_price&&e.payment_mode_uuid&&e.debtor_name){const l=await F.payUnclearedBill(e);l.status==="success"?(le.refetchQueries("bills"),m.value="",ue.value="",q.value=!1,x.value=!1,A(l.message,"green","top")):(B.value=l.message,A(l.message,"red","top-right"))}else x.value=!1,B.value="Name is required!",A("Name is required!","red","top-right")},re=n=>{const e=[];n.sales.forEach(_=>{e.push({name:_.name,quantity:_.quantity,price:_.selling_price,total:_.quantity*_.selling_price})});const l={title:"Sales Receipt",status:n.status==="sold"?"Sold":"Pending Payment",user:n.user,payment_mode:n.payment_mode};Ve(e,["name","quantity","price","total"],l)},A=(n,e,l)=>{ae.notify({message:n,color:e,position:l})};return(n,e)=>(c(),f("div",Se,[$(ne)?(c(),f("div",xe,"Loading bills...")):$(R)?(c(),f("div",Be,"An error has occurred: "+o($(R)),1)):(c(),b(be,{key:2,grid:"",flat:"",bordered:"",title:"Uncleared Bills",rows:O.value,"row-key":"bill_ref",filter:M.value},{"top-right":t(()=>[a(Z,{class:"q-mr-sm q-mb-sm"},{default:t(()=>[a(h,{icon:"list",size:"sm",color:"primary",label:"All Bills",to:"/bills"})]),_:1}),a(C,{dense:"",debounce:"300",outlined:"",modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=l=>M.value=l),placeholder:"Search"},{append:t(()=>[a(W,{name:"search"})]),_:1},8,["modelValue"])]),item:t(l=>[u("div",Pe,[a(ee,{bordered:"",class:L(`${l.row.status=="pending"?"sale_pending":""}`)},{default:t(()=>{var _,J;return[u("div",{class:L(["text-center q-pa-xs",`${l.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[u("small",null,[u("strong",null,[a(W,{name:"description",style:{"margin-bottom":"2px"}}),s(" BILL-"+o(l.row.bill_ref),1)])])],2),a(k,null,{default:t(()=>[u("div",De,[u("strong",null," Created by : "+o(l.row.user),1),a(E)]),a(D,{class:"q-mb-sm"}),u("div",Ne,[u("small",null,"Created On : "+o(l.row.created_at),1),s(),Me,u("small",null,[a(ve,{color:"blue"},{default:t(()=>[s("Status : "+o(l.row.status)+" ",1),Ie,s(" Mode : "+o(l.row.payment_mode),1)]),_:2},1024)])]),a(D,{class:"q-mb-sm"}),u("small",null,[a(N,{dense:"",bordered:"",separator:"",class:"debt_bill"},{default:t(()=>[a(Q,null,{default:t(()=>[a(i,null,{default:t(()=>[s("Name")]),_:1}),a(i,null,{default:t(()=>[s("Price")]),_:1}),a(i,{style:{color:"white"}},{default:t(()=>[s("Quantity")]),_:1}),a(i,{style:{color:"white"}},{default:t(()=>[s("Total")]),_:1}),l.row.status==="pending"&&l.row.sales.length>1?(c(),b(i,{key:0},{default:t(()=>[s("Action")]),_:1})):p("",!0)]),_:2},1024)]),_:2},1024)]),a(N,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),f(X,null,Y(l.row.sales,(d,v)=>(c(),b(Q,{key:v},{default:t(()=>[a(i,null,{default:t(()=>[s(o(d.name),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.selling_price),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.quantity),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o((d.quantity*d.selling_price).toFixed(2)),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),a(D),((J=(_=l==null?void 0:l.row)==null?void 0:_.debtors)==null?void 0:J.length)>0?(c(),b(k,{key:0},{default:t(()=>[u("small",null,[Ue,a(N,{dense:"",bordered:"",separator:""},{default:t(()=>[a(Q,null,{default:t(()=>[a(i,null,{default:t(()=>[s("Paid")]),_:1}),a(i,null,{default:t(()=>[s("Balance")]),_:1}),a(i,null,{default:t(()=>[s("Mode")]),_:1}),a(i,null,{default:t(()=>[s("Date")]),_:1})]),_:1})]),_:1}),a(N,{dense:"",bordered:"",separator:""},{default:t(()=>[(c(!0),f(X,null,Y(l.row.debtors,(d,v)=>(c(),b(Q,{key:v},{default:t(()=>[a(i,null,{default:t(()=>[s(o(d.amount_paid),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.balance),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.payment_mode),1)]),_:2},1024),a(i,null,{default:t(()=>[s(o(d.created_at),1)]),_:2},1024)]),_:2},1024))),128)),a(Q,{class:"bg-indigo text-white"},{default:t(()=>[a(i,null,{default:t(()=>[s("Total Debt Cleared")]),_:1}),a(i,null,{default:t(()=>{var d;return[s(o((d=l==null?void 0:l.row)==null?void 0:d.total_debt_paid),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):p("",!0),a(D),a(k,{class:"text-center"},{default:t(()=>{var d,v,j,H;return[u("small",null,[u("p",null,"Debtor: "+o(l.row.debtor_name),1),u("b",null,"Initial Debt Ksh "+o((d=l==null?void 0:l.row)==null?void 0:d.selling_price),1),s(),Ae,((v=l==null?void 0:l.row)==null?void 0:v.total_debt_paid)>0?(c(),f("b",$e,"Amount due Ksh "+o(((j=l==null?void 0:l.row)==null?void 0:j.selling_price)-((H=l==null?void 0:l.row)==null?void 0:H.total_debt_paid)),1)):p("",!0)])]}),_:2},1024),a(k,{style:{padding:"0"}},{default:t(()=>[a(Z,{class:"full-width"},{default:t(()=>[a(h,{class:"full-width",dense:"",flat:"",onClick:d=>re(l.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),a(h,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Clear Bill",icon:"grain",onClick:d=>oe(l.row)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]}),_:2},1032,["class"])])]),_:1},8,["rows","filter"])),a(pe,{modelValue:q.value,"onUpdate:modelValue":e[7]||(e[7]=l=>q.value=l),persistent:""},{default:t(()=>[a(ee,{style:{width:"500px"}},{default:t(()=>[a(he,null,{default:t(()=>[Le,a(E),u("small",Ee,[a(h,{disabled:m.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:L(`${w.value?"":"actual_selling_price"}`),onClick:e[1]||(e[1]=l=>w.value=!w.value),label:`Full payment : ${P.value}`},null,8,["disabled","class","label"])])]),_:1}),a(k,{class:"q-pt-none"},{default:t(()=>[!w.value&&m.value.name!=="Mpesa & Cash"?(c(),b(C,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual amount paid",modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=l=>y.value=l),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):p("",!0),y.value&&y.value>0?(c(),b(ye,{key:1,dense:"",outlined:"",modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=l=>m.value=l),options:G.value,"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):p("",!0),m.value.name==="Mpesa & Cash"?(c(),f("div",Te,[u("div",Fe,[a(C,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=l=>I.value=l)},null,8,["modelValue"]),a(C,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:U.value,"onUpdate:modelValue":e[5]||(e[5]=l=>U.value=l)},null,8,["modelValue"])])])):p("",!0),m.value.name==="Debt"?(c(),f("div",ze,[a(C,{outlined:"",modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=l=>z.value=l),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):p("",!0)]),_:1}),u("div",Ke,[u("small",null,o(B.value),1)]),a(ge,{align:"right"},{default:t(()=>[a(h,{flat:"",label:"Cancel",color:"red",onClick:ie}),a(E),y.value&&m.value?(c(),b(h,{key:0,flat:"",label:"Pay",color:"primary",onClick:de,loading:x.value},null,8,["loading"])):p("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var cl=ce(Oe,[["__scopeId","data-v-845e10e8"]]);export{cl as default};
