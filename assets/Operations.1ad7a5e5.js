import{c8 as qe,c5 as Se,r,c as Ve,aI as c,a5 as S,a6 as o,P as u,u as h,a3 as C,bb as a,d as e,a4 as V,bD as Q,ac as n,M as K,F as ke,aO as we,bE as g}from"./index.104f6ae1.js";import{Q as Y,a as J}from"./QBadge.e5611531.js";import{a as I,Q as M}from"./QCard.4f99fc1d.js";import{Q as A}from"./QInput.2343ca30.js";import{Q as Ce,c as W,f as F,d as D,e as X}from"./QCardActions.e5ce3c72.js";import{p as Z,n as O,o as d}from"./rtl.9bf9d968.js";import{Q as Qe}from"./QSeparator.66c9c541.js";import{Q as xe}from"./QBtnGroup.fcc107dc.js";import{a as Ne}from"./use-quasar.f532f3dd.js";import{u as R}from"./index.3178a3ef.js";import{p as Pe}from"./product_columns.133b4496.js";import{u as $e}from"./product-store.c13069a5.js";import{u as Ae}from"./payment-mode-store.19fa488f.js";import{u as De}from"./sale-store.c83f31eb.js";import{u as Be}from"./debtor-store.ec027866.js";import{p as Ee}from"./print.15699711.js";import"./use-dark.abb6de42.js";import"./module_calls.c637478d.js";import"./helpers.d60dad50.js";import"./_commonjsHelpers.6150b38b.js";const Ie=qe("operation",{state:()=>({selected_products:[]}),actions:{}});const Me={class:"q-pa-md"},Oe={class:"row",style:{overflow:"hidden"}},Te={class:"q-pa-xs col-xs-12 col-sm-6 col-md-7",style:{overflow:"auto"}},Ue={style:{color:"red"}},Le={key:0},ze={key:1},Fe=["onClick"],Re={style:{color:"#017951"}},He=o("hr",null,null,-1),je=o("hr",null,null,-1),Ge=o("br",null,null,-1),Ke=o("br",null,null,-1),Ye=o("br",null,null,-1),Je={key:0,class:"q-pa-xs col-xs-12 col-sm-6 col-md-5",style:{overflow:"auto"}},We={style:{color:"orange"}},Xe=o("br",null,null,-1),Ze=o("br",null,null,-1),el=o("hr",null,null,-1),ll={class:"text-h6"},tl={class:"text-center error_msg"},al=o("div",{class:"text-h6"},"Make Payment",-1),ol={class:"q-mt-sm"},sl={key:2,class:"q-pa-sm"},ul={class:"row q-col-gutter-sm"},nl={key:3,class:"q-pt-sm"},rl={class:"text-center error_msg"},Pl={__name:"Operations",setup(il){const H=Se(),ee=Ne(),le=$e(),te=Ae(),j=De(),ae=Be(),oe=Ie(),q=r(!1),k=r(!1),x=r(!1),N=r(!0),T=r(""),m=r(1),w=r(1),U=r(1),L=r(1),P=r(""),p=r(""),se=r(""),_=r(""),B=r(""),v=r("");let i=oe.selected_products;const{data:ue,isLoading:ne,isError:G}=R("products",()=>le.fetchProducts()),{data:re}=R("payment_modes",()=>te.fetchPaymentModes());let E=[];R("debtors",()=>ae.fetchDebtors(),{onSuccess:s=>{E=s.map(t=>({name:t.name,uuid:t.uuid}))}});const z=r(E),ie=r(null),de=(s,t)=>{if(s===""){t(()=>{z.value=E});return}t(()=>{const l=s.toLowerCase();z.value=E.filter(b=>b.name.toLowerCase().indexOf(l)>-1)})},ce=s=>{s.quantity<1?(_.value=`${s.name} quantity is zero. Add more from INVENTORIES.`,B.value=`${s.name} quantity is zero. Add more from INVENTORIES.`,f(`${s.name} quantity is zero. Add more from INVENTORIES`,"red","top")):(_.value="",B.value="",i.some(t=>t.name==s.name)?(_.value="Product already added to the bill! Select a different product.",B.value="Product already added to the bill! Select a different product.",f(`${s.name} already added to the bill!`,"red","top")):(x.value=!0,v.value=s))},me=()=>{k.value=!0},pe=()=>{x.value=!1,v.value="",m.value=1},_e=()=>{if(m.value>v.value.quantity)_.value=`${m.value} is more than the maximum available quantity`,f(`${m.value} is more than the maximum available quantity`,"red","top");else{const s={uuid:v.value.uuid,name:v.value.name,price:v.value.selling_price,quantity:m.value};i.push(s),f(`${v.value.name} added to cart!`,"green","top"),x.value=!1,v.value="",m.value=1}},$=Ve(()=>{let s=0;return i.forEach(t=>{s+=t.quantity*t.price}),s}),ve=s=>i.splice(s,1),fe=()=>{confirm("Are you sure?")&&i.splice(0,i.length)},be=async()=>{q.value=!0;let s=[];i.forEach(l=>s.push({name:l.name,quantity:l.quantity,uuid:l.uuid}));const t={products:s,payment_mode_uuid:p.value.uuid,bill_status:"sold",debtor_uuid:P.value.uuid};if(p.value.name==="Mpesa & Cash"){const l=Number(U.value)+Number(L.value);t.selling_price=l,t.actual_selling_price=l}else N.value?(t.selling_price=Number($.value),t.actual_selling_price=Number($.value)):(t.selling_price=Number($.value),t.actual_selling_price=Number(w.value));if(t.selling_price&&t.payment_mode_uuid)if(p.value.name==="Debt"&&!P.value)alert("Debtor name is required."),_.value="Debtor name is required.",q.value=!1;else{const l=await j.createSaleOperation(t);l.status==="success"?(p.value="",m.value="",P.value="",k.value=!1,i.splice(0,i.length),q.value=!1,H.push("/bills"),f(l.message,"green","top")):(_.value=l.message,f(l.message,"red","top-right"))}else _.value="Name is required!",f("Name is required!","red","top-right")},ye=async()=>{var l;q.value=!0;let s=[];if(confirm("Are you sure?")){i.forEach(y=>s.push({name:y.name,quantity:y.quantity,uuid:y.uuid}));const b={products:s};if((l=b==null?void 0:b.products)!=null&&l.length){const y=await j.createHoldBillOperation(b);y.status==="success"?(p.value="",m.value="",k.value=!1,i.splice(0,i.length),q.value=!1,H.push("/bills"),f(y.message,"green","top")):(_.value=y.message,f(y.message,"red","top-right"))}else _.value="Name is required!",f("Name is required!","red","top-right")}},he=()=>{k.value=!1,m.value="",se.value="",_.value=""},f=(s,t,l)=>{ee.notify({message:s,color:t,position:l})},ge=()=>{Ee({printable:i,properties:["name","quantity"],type:"json",gridHeaderStyle:"color: red;  border: 2px solid #3971A5;",gridStyle:"border: 2px solid #3971A5;"})};return(s,t)=>(c(),S("div",Me,[o("div",Oe,[o("div",Te,[o("small",Ue,u(B.value),1),h(ne)?(c(),S("div",Le,"Loading products...")):h(G)?(c(),S("div",ze,"An error has occurred: "+u(h(G)),1)):(c(),C(Ce,{key:2,title:"Make Sale (All Products)",rows:h(ue),columns:h(Pe),separator:"cell","row-key":"name",filter:T.value,dense:"",grid:""},{item:a(l=>[o("div",{class:"q-pa-xs col-xs-12 col-sm-6 col-md-4",onClick:b=>ce(l.row)},[e(I,{bordered:"",class:K(["selected_product",`${l.row.quantity<1?"minQty":""}`])},{default:a(()=>[e(M,{class:"text-center"},{default:a(()=>[o("strong",Re,[e(Q,{name:"bubble_chart"}),n(" "+u(l.row.name),1)]),He,o("small",null,[o("i",null,[n("Selling Price: "),o("b",null,"Ksh "+u(l.row.selling_price),1)])]),je,o("small",null,[o("i",null,"Category: "+u(l.row.category),1)]),Ge,o("small",null,[o("i",null,"Department: "+u(l.row.department),1)]),Ke,o("small",null,[e(Y,{color:`${l.row.quantity<1?"red":"orange"}`},{default:a(()=>[n("Available Quantity "),Ye,n(u(l.row.quantity)+" "+u(l.row.measurement),1)]),_:2},1032,["color"])])]),_:2},1024)]),_:2},1032,["class"])],8,Fe)]),"top-right":a(()=>[e(A,{borderless:"",dense:"",outlined:"",rounded:"",debounce:"300",modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=l=>T.value=l),placeholder:"Search product...",class:"q-mr-md"},{append:a(()=>[e(Q,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["rows","columns","filter"]))]),h(i).length>0?(c(),S("div",Je,[e(I,{bordered:""},{default:a(()=>[e(F,null,{default:a(()=>[o("i",null,[e(Q,{name:"shopping_cart"}),n(" New Bill")]),n(),e(D),o("span",We,"(Items: "+u(h(i).length)+")",1)]),_:1}),e(M,null,{default:a(()=>[e(Z,{bordered:"",separator:"",dense:"",class:"bill"},{default:a(()=>[e(O,null,{default:a(()=>[e(d,null,{default:a(()=>[n("Name")]),_:1}),e(d,{style:{color:"white"}},{default:a(()=>[n("Price")]),_:1}),e(d,{style:{color:"white"}},{default:a(()=>[n("Quantity")]),_:1}),e(d,{side:"",style:{color:"white"}},{default:a(()=>[n("Total")]),_:1}),e(d,{avatar:""},{default:a(()=>[e(Q,{class:"select_list",name:"delete",dense:"",color:"white",onClick:fe})]),_:1})]),_:1})]),_:1}),Xe,e(Z,{bordered:"",separator:"",dense:""},{default:a(()=>[(c(!0),S(ke,null,we(h(i),(l,b)=>(c(),C(O,{key:l.uuid},{default:a(()=>[e(d,null,{default:a(()=>[n(u(l.name),1)]),_:2},1024),e(d,null,{default:a(()=>[n(u(l.price),1)]),_:2},1024),e(d,null,{default:a(()=>[n(u(l.quantity),1)]),_:2},1024),e(d,{side:""},{default:a(()=>[n(u(l.price*l.quantity),1)]),_:2},1024),e(d,{avatar:""},{default:a(()=>[e(Q,{class:"select_list",name:"delete",dense:"",color:"red",onClick:y=>ve(b)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),e(Qe,{color:"orange"}),e(O,null,{default:a(()=>[e(d,null,{default:a(()=>[n("Total")]),_:1}),e(d,{avatar:""},{default:a(()=>[n(u($.value),1)]),_:1}),e(d,{avatar:""})]),_:1})]),_:1}),Ze,e(xe,{spread:"",rounded:""},{default:a(()=>[e(g,{size:"sm",color:"primary",label:"Sale",icon:"grain",onClick:me}),e(g,{size:"sm",color:"orange",label:"Hold Bill",icon:"pan_tool",onClick:ye,loading:q.value},null,8,["loading"])]),_:1}),el,e(g,{color:"primary",flat:"",class:"full-width",label:"Print Bill",icon:"print",onClick:ge})]),_:1})]),_:1})])):V("",!0)]),e(W,{modelValue:x.value,"onUpdate:modelValue":t[2]||(t[2]=l=>x.value=l),persistent:""},{default:a(()=>[e(I,{style:{width:"500px"}},{default:a(()=>[e(J,null,{default:a(()=>[o("div",ll,[e(Q,{name:"bubble_chart"}),n(" "+u(v.value.name),1)]),e(D),o("small",null,[e(Y,null,{default:a(()=>[n(u(v.value.measurement),1)]),_:1})])]),_:1}),e(M,{class:"q-pt-none"},{default:a(()=>[e(A,{autofocus:"",outlined:"",dense:"",label:"Product Quantity",modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=l=>m.value=l),type:"number",hint:`Note : You can sale a maximum of ${v.value.quantity}`},null,8,["modelValue","hint"])]),_:1}),o("div",tl,[o("small",null,u(_.value),1)]),e(F,{align:"right"},{default:a(()=>[e(g,{flat:"",label:"Cancel",color:"red",onClick:pe}),e(D),m.value?(c(),C(g,{key:0,flat:"",label:"Add Product",color:"primary",onClick:_e})):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(W,{modelValue:k.value,"onUpdate:modelValue":t[10]||(t[10]=l=>k.value=l),persistent:""},{default:a(()=>[e(I,{style:{width:"500px"}},{default:a(()=>[e(J,null,{default:a(()=>[al,e(D),o("small",ol,[e(g,{disabled:p.value.name==="Mpesa & Cash",size:"sm",dense:"",color:"blue",depressed:"",class:K(`${N.value?"":"actual_selling_price"}`),onClick:t[3]||(t[3]=l=>N.value=!N.value),label:`Expected Selling Price : ${$.value}`},null,8,["disabled","class","label"])])]),_:1}),e(M,{class:"q-pt-none"},{default:a(()=>[!N.value&&p.value.name!=="Mpesa & Cash"?(c(),C(A,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:w.value,"onUpdate:modelValue":t[4]||(t[4]=l=>w.value=l),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):V("",!0),w.value&&w.value>0?(c(),C(X,{key:1,dense:"",outlined:"",modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=l=>p.value=l),options:h(re),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):V("",!0),p.value.name==="Mpesa & Cash"?(c(),S("div",sl,[o("div",ul,[e(A,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:U.value,"onUpdate:modelValue":t[6]||(t[6]=l=>U.value=l)},null,8,["modelValue"]),e(A,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:L.value,"onUpdate:modelValue":t[7]||(t[7]=l=>L.value=l)},null,8,["modelValue"])])])):V("",!0),p.value.name==="Debt"?(c(),S("div",nl,[e(X,{outlined:"",dense:"",modelValue:P.value,"onUpdate:modelValue":t[8]||(t[8]=l=>P.value=l),"use-input":"","input-debounce":"0",label:"Select debtor",options:z.value,"option-value":"uuid","option-label":"name",onFilter:de,behavior:"menu",onOnchange:t[9]||(t[9]=l=>s.$emit("selectDebtor",ie.value)),hint:"Type in debtor name to filter..."},{"no-option":a(()=>[e(O,null,{default:a(()=>[e(d,{class:"text-grey"},{default:a(()=>[e(g,{size:"sm",outline:"",label:"No results? CLick here to create new debtor.",to:"/debtors",color:"primary"})]),_:1})]),_:1})]),_:1},8,["modelValue","options"])])):V("",!0)]),_:1}),o("div",rl,[o("small",null,u(_.value),1)]),e(F,{align:"right"},{default:a(()=>[e(g,{flat:"",label:"Cancel",color:"red",onClick:he}),e(D),w.value&&p.value?(c(),C(g,{key:0,flat:"",label:"Sale",color:"primary",onClick:be,loading:q.value},null,8,["loading"])):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{Pl as default};
