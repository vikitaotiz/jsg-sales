import{c8 as fe,c5 as ye,r as i,c as be,aI as d,a5 as S,a6 as o,P as u,u as y,a3 as w,bb as t,b as ge,d as e,a4 as V,bD as x,ac as n,M as j,F as he,aO as qe,bE as g}from"./index.0fdde7d8.js";import{Q as G,a as K}from"./QBadge.0c8833c5.js";import{a as D,Q as I}from"./QCard.2399c3c3.js";import{Q as C}from"./QInput.38269e70.js";import{Q as Se,c as Y,p as Ve,f as z,d as B,e as ke}from"./paginations.d5ef5921.js";import{p as J,n as L,o as c}from"./rtl.ac90c64b.js";import{Q as Qe}from"./QSeparator.0d2732c0.js";import{Q as we}from"./QBtnGroup.5b507273.js";import{a as xe}from"./use-quasar.cc67a347.js";import{u as W}from"./index.82ab6ec2.js";import"./helpers.3d5d05cf.js";import{p as Ce}from"./product_columns.133b4496.js";import{u as Ne}from"./product-store.5917bf24.js";import{u as Pe}from"./payment-mode-store.daf14280.js";import{u as Ae}from"./sale-store.6c59e51b.js";import{p as $e}from"./print.15699711.js";import"./use-dark.e1785afc.js";import"./module_calls.b5021e26.js";import"./_commonjsHelpers.6150b38b.js";const Be=fe("operation",{state:()=>({selected_products:[]}),actions:{}});const Ee={class:"q-pa-md"},De={class:"row",style:{overflow:"hidden"}},Ie={class:"q-pa-xs col-xs-12 col-sm-6 col-md-7",style:{overflow:"auto"}},Me={style:{color:"red"}},Ue={key:0},Oe={key:1},Te=["onClick"],ze={style:{color:"#017951"}},Le=o("hr",null,null,-1),Re=o("hr",null,null,-1),He=o("br",null,null,-1),Fe=o("br",null,null,-1),je=o("br",null,null,-1),Ge={key:0,class:"q-pa-xs col-xs-12 col-sm-6 col-md-5",style:{overflow:"auto"}},Ke={style:{color:"orange"}},Ye=o("br",null,null,-1),Je=o("br",null,null,-1),We=o("hr",null,null,-1),Xe={class:"text-h6"},Ze={class:"text-center error_msg"},el=o("div",{class:"text-h6"},"Make Payment",-1),ll={class:"q-mt-sm"},al={key:2,class:"q-pa-sm"},tl={class:"row q-col-gutter-sm"},ol={key:3,class:"q-pt-sm"},sl={class:"text-center error_msg"},wl={__name:"Operations",setup(ul){const R=ye(),X=xe(),Z=Ne(),ee=Pe(),H=Ae(),le=Be(),M=Ve(10),h=i(!1),k=i(!1),N=i(!1),P=i(!0),U=i(""),m=i(1),Q=i(1),O=i(1),T=i(1),A=i(""),p=i(""),ae=i(""),_=i(""),E=i(""),v=i("");let r=le.selected_products;const{data:te,isLoading:oe,isError:F}=W("products",()=>Z.fetchProducts()),{data:se}=W("payment_modes",()=>ee.fetchPaymentModes()),ue=s=>{s.quantity===0?(_.value=`${s.name} quantity is zero. Add more from INVENTORIES.`,E.value=`${s.name} quantity is zero. Add more from INVENTORIES.`,f(`${s.name} quantity is zero. Add more from INVENTORIES`,"red","top")):(_.value="",E.value="",r.some(a=>a.name==s.name)?(_.value="Product already added to the bill! Select a different product.",E.value="Product already added to the bill! Select a different product.",f(`${s.name} already added to the bill!`,"red","top")):(N.value=!0,v.value=s))},ne=()=>{k.value=!0},re=()=>{N.value=!1,v.value="",m.value=1},ie=()=>{if(m.value>v.value.quantity)_.value=`${m.value} is more than the maximum available quantity`,f(`${m.value} is more than the maximum available quantity`,"red","top");else{const s={uuid:v.value.uuid,name:v.value.name,price:v.value.selling_price,quantity:m.value};r.push(s),f(`${v.value.name} added to cart!`,"green","top"),N.value=!1,v.value="",m.value=1}},$=be(()=>{let s=0;return r.forEach(a=>{s+=a.quantity*a.price}),s}),de=s=>r.splice(s,1),ce=()=>{confirm("Are you sure?")&&r.splice(0,r.length)},me=async()=>{h.value=!0;let s=[];r.forEach(l=>s.push({name:l.name,quantity:l.quantity,uuid:l.uuid}));const a={products:s,payment_mode_uuid:p.value.uuid,bill_status:"sold",debtor_name:A.value};if(p.value.name==="Mpesa & Cash"){const l=Number(O.value)+Number(T.value);a.selling_price=l,a.actual_selling_price=l}else P.value?(a.selling_price=Number($.value),a.actual_selling_price=Number($.value)):(a.selling_price=Number($.value),a.actual_selling_price=Number(Q.value));if(a.selling_price&&a.payment_mode_uuid)if(p.value.name==="Debt"&&!A.value)alert("Debtor name is required."),_.value="Debtor name is required.",h.value=!1;else{const l=await H.createSaleOperation(a);l.status==="success"?(p.value="",m.value="",A.value="",k.value=!1,r.splice(0,r.length),h.value=!1,R.push("/bills"),f(l.message,"green","top")):(_.value=l.message,f(l.message,"red","top-right"))}else _.value="Name is required!",f("Name is required!","red","top-right")},pe=async()=>{var l;h.value=!0;let s=[];if(confirm("Are you sure?")){r.forEach(b=>s.push({name:b.name,quantity:b.quantity,uuid:b.uuid}));const q={products:s};if((l=q==null?void 0:q.products)!=null&&l.length){const b=await H.createHoldBillOperation(q);b.status==="success"?(p.value="",m.value="",k.value=!1,r.splice(0,r.length),h.value=!1,R.push("/bills"),f(b.message,"green","top")):(_.value=b.message,f(b.message,"red","top-right"))}else _.value="Name is required!",f("Name is required!","red","top-right")}},_e=()=>{k.value=!1,m.value="",ae.value="",_.value=""},f=(s,a,l)=>{X.notify({message:s,color:a,position:l})},ve=()=>{$e({printable:r,properties:["name","quantity"],type:"json",gridHeaderStyle:"color: red;  border: 2px solid #3971A5;",gridStyle:"border: 2px solid #3971A5;"})};return(s,a)=>(d(),S("div",Ee,[o("div",De,[o("div",Ie,[o("small",Me,u(E.value),1),y(oe)?(d(),S("div",Ue,"Loading products...")):y(F)?(d(),S("div",Oe,"An error has occurred: "+u(y(F)),1)):(d(),w(Se,{key:2,title:"Make Sale (All Products)",rows:y(te),columns:y(Ce),pagination:y(M),"onUpdate:pagination":a[1]||(a[1]=l=>ge(M)?M.value=l:null),separator:"cell","row-key":"name",filter:U.value,dense:"",grid:""},{item:t(l=>[o("div",{class:"q-pa-xs col-xs-12 col-sm-6 col-md-4",onClick:q=>ue(l.row)},[e(D,{bordered:"",class:j(["selected_product",`${l.row.quantity===0?"minQty":""}`])},{default:t(()=>[e(I,{class:"text-center"},{default:t(()=>[o("strong",ze,[e(x,{name:"bubble_chart"}),n(" "+u(l.row.name),1)]),Le,o("small",null,[o("i",null,[n("Selling Price: "),o("b",null,"Ksh "+u(l.row.selling_price),1)])]),Re,o("small",null,[o("i",null,"Category: "+u(l.row.category),1)]),He,o("small",null,[o("i",null,"Department: "+u(l.row.department),1)]),Fe,o("small",null,[e(G,{color:`${l.row.quantity===0?"red":"orange"}`},{default:t(()=>[n("Available Quantity "),je,n(u(l.row.quantity)+" "+u(l.row.measurement),1)]),_:2},1032,["color"])])]),_:2},1024)]),_:2},1032,["class"])],8,Te)]),"top-right":t(()=>[e(C,{borderless:"",dense:"",outlined:"",rounded:"",debounce:"300",modelValue:U.value,"onUpdate:modelValue":a[0]||(a[0]=l=>U.value=l),placeholder:"Search product...",class:"q-mr-md"},{append:t(()=>[e(x,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["rows","columns","pagination","filter"]))]),y(r).length>0?(d(),S("div",Ge,[e(D,{bordered:""},{default:t(()=>[e(z,null,{default:t(()=>[o("i",null,[e(x,{name:"shopping_cart"}),n(" New Bill")]),n(),e(B),o("span",Ke,"(Items: "+u(y(r).length)+")",1)]),_:1}),e(I,null,{default:t(()=>[e(J,{bordered:"",separator:"",dense:"",class:"bill"},{default:t(()=>[e(L,null,{default:t(()=>[e(c,null,{default:t(()=>[n("Name")]),_:1}),e(c,{style:{color:"white"}},{default:t(()=>[n("Price")]),_:1}),e(c,{style:{color:"white"}},{default:t(()=>[n("Quantity")]),_:1}),e(c,{side:"",style:{color:"white"}},{default:t(()=>[n("Total")]),_:1}),e(c,{avatar:""},{default:t(()=>[e(x,{class:"select_list",name:"delete",dense:"",color:"white",onClick:ce})]),_:1})]),_:1})]),_:1}),Ye,e(J,{bordered:"",separator:"",dense:""},{default:t(()=>[(d(!0),S(he,null,qe(y(r),(l,q)=>(d(),w(L,{key:l.uuid},{default:t(()=>[e(c,null,{default:t(()=>[n(u(l.name),1)]),_:2},1024),e(c,null,{default:t(()=>[n(u(l.price),1)]),_:2},1024),e(c,null,{default:t(()=>[n(u(l.quantity),1)]),_:2},1024),e(c,{side:""},{default:t(()=>[n(u(l.price*l.quantity),1)]),_:2},1024),e(c,{avatar:""},{default:t(()=>[e(x,{class:"select_list",name:"delete",dense:"",color:"red",onClick:b=>de(q)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),e(Qe,{color:"orange"}),e(L,null,{default:t(()=>[e(c,null,{default:t(()=>[n("Total")]),_:1}),e(c,{avatar:""},{default:t(()=>[n(u($.value),1)]),_:1}),e(c,{avatar:""})]),_:1})]),_:1}),Je,e(we,{spread:"",rounded:""},{default:t(()=>[e(g,{size:"sm",color:"primary",label:"Sale",icon:"grain",onClick:ne}),e(g,{size:"sm",color:"orange",label:"Hold Bill",icon:"pan_tool",onClick:pe,loading:h.value},null,8,["loading"])]),_:1}),We,e(g,{color:"primary",flat:"",class:"full-width",label:"Print Bill",icon:"print",onClick:ve})]),_:1})]),_:1})])):V("",!0)]),e(Y,{modelValue:N.value,"onUpdate:modelValue":a[3]||(a[3]=l=>N.value=l),persistent:""},{default:t(()=>[e(D,{style:{width:"500px"}},{default:t(()=>[e(K,null,{default:t(()=>[o("div",Xe,[e(x,{name:"bubble_chart"}),n(" "+u(v.value.name),1)]),e(B),o("small",null,[e(G,null,{default:t(()=>[n(u(v.value.measurement),1)]),_:1})])]),_:1}),e(I,{class:"q-pt-none"},{default:t(()=>[e(C,{autofocus:"",outlined:"",dense:"",label:"Product Quantity",modelValue:m.value,"onUpdate:modelValue":a[2]||(a[2]=l=>m.value=l),type:"number",hint:`Note : You can sale a maximum of ${v.value.quantity}`},null,8,["modelValue","hint"])]),_:1}),o("div",Ze,[o("small",null,u(_.value),1)]),e(z,{align:"right"},{default:t(()=>[e(g,{flat:"",label:"Cancel",color:"red",onClick:re}),e(B),m.value?(d(),w(g,{key:0,flat:"",label:"Add Product",color:"primary",onClick:ie})):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(Y,{modelValue:k.value,"onUpdate:modelValue":a[10]||(a[10]=l=>k.value=l),persistent:""},{default:t(()=>[e(D,{style:{width:"500px"}},{default:t(()=>[e(K,null,{default:t(()=>[el,e(B),o("small",ll,[e(g,{disabled:p.value.name==="Mpesa & Cash",size:"sm",dense:"",color:"blue",depressed:"",class:j(`${P.value?"":"actual_selling_price"}`),onClick:a[4]||(a[4]=l=>P.value=!P.value),label:`Expected Selling Price : ${$.value}`},null,8,["disabled","class","label"])])]),_:1}),e(I,{class:"q-pt-none"},{default:t(()=>[!P.value&&p.value.name!=="Mpesa & Cash"?(d(),w(C,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:Q.value,"onUpdate:modelValue":a[5]||(a[5]=l=>Q.value=l),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):V("",!0),Q.value&&Q.value>0?(d(),w(ke,{key:1,dense:"",outlined:"",modelValue:p.value,"onUpdate:modelValue":a[6]||(a[6]=l=>p.value=l),options:y(se),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):V("",!0),p.value.name==="Mpesa & Cash"?(d(),S("div",al,[o("div",tl,[e(C,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:O.value,"onUpdate:modelValue":a[7]||(a[7]=l=>O.value=l)},null,8,["modelValue"]),e(C,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:T.value,"onUpdate:modelValue":a[8]||(a[8]=l=>T.value=l)},null,8,["modelValue"])])])):V("",!0),p.value.name==="Debt"?(d(),S("div",ol,[e(C,{outlined:"",dense:"",label:"Debtor Name",modelValue:A.value,"onUpdate:modelValue":a[9]||(a[9]=l=>A.value=l),required:""},null,8,["modelValue"])])):V("",!0)]),_:1}),o("div",sl,[o("small",null,u(_.value),1)]),e(z,{align:"right"},{default:t(()=>[e(g,{flat:"",label:"Cancel",color:"red",onClick:_e}),e(B),Q.value&&p.value?(d(),w(g,{key:0,flat:"",label:"Sale",color:"primary",onClick:me,loading:h.value},null,8,["loading"])):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{wl as default};
